<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¼ì›… â¤ï¸ ì§€ì€ ì›¨ë”© í”Œë˜ë„ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #FFFBF7; }
        .font-handwriting { font-family: 'Dancing Script', cursive; }
        .tab-button.active { border-bottom-color: #D98BA0; color: #D98BA0; font-weight: 700; }
        .completed { text-decoration: line-through; color: #9ca3af; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .draggable { cursor: grab; }
        .dragging { opacity: 0.5; background: #d98ba040; }
        .item-content { cursor: pointer; }
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; touch-action: none; }
        .lightbox-content { max-width: 90vw; max-height: 85vh; }
        .lightbox-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); color: white; font-size: 30px; cursor: pointer; padding: 16px; user-select: none; }
        .lightbox-prev { left: 10px; }
        .lightbox-next { right: 10px; }
        .photo-selection-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; border: 3px solid #D98BA0; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        /* Accordion style */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary.guest-summary::after { content: 'â–¸'; float: right; transition: transform 0.2s; margin-left: auto; }
        details[open] > summary.guest-summary::after { transform: rotate(90deg); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Password Gate -->
    <div id="password-gate" class="min-h-screen flex items-center justify-center bg-[#FFFBF7]">
        <div class="bg-white p-8 rounded-lg shadow-lg text-center w-full max-w-sm">
            <h2 class="font-handwriting text-4xl text-pink-500 mb-4">Minwung & Jieun</h2>
            <p class="text-gray-600 mb-6">ìš°ë¦¬ì˜ ì›¨ë”© í”Œë˜ë„ˆ</p>
            <input type="password" id="password-input" class="w-full p-3 border rounded-lg text-center" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <p id="password-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <button onclick="checkPassword()" class="w-full bg-pink-500 text-white p-3 rounded-lg hover:bg-pink-600 mt-4">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <div class="container mx-auto p-4 max-w-4xl">
            <!-- Header -->
            <header class="text-center mb-6">
                <h1 class="font-handwriting text-5xl md:text-6xl font-bold text-pink-500">Minwung & Jieun</h1>
                <p class="text-md text-gray-500 mt-2">ìš°ë¦¬ê°€ í•¨ê»˜ ë§Œë“œëŠ” ê²°í˜¼ ì´ì•¼ê¸°</p>
                <div class="mt-4 text-center space-y-2">
                    <div id="wedding-date-container" class="relative inline-block group cursor-pointer">
                        <div id="d-day-counter" class="text-xl font-semibold bg-white p-3 rounded-lg shadow-md">...</div>
                        <div id="wedding-date-display" class="text-xs text-gray-500 mt-1"></div>
                        <input type="hidden" id="wedding-date-picker">
                    </div>
                    <div id="days-together-counter" class="text-sm text-gray-600">...</div>
                </div>
            </header>

            <!-- Tabs -->
            <div class="mb-6 border-b border-gray-200 sticky top-0 bg-[#FFFBF7] z-10">
                <nav class="flex justify-around" aria-label="Tabs">
                    <button onclick="changeTab('checklist')" class="tab-button active w-full text-center py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-check-square mr-1"></i>ì²´í¬ë¦¬ìŠ¤íŠ¸</button>
                    <button onclick="changeTab('budget')" class="tab-button w-full text-center py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-coins mr-1"></i>ì˜ˆì‚° ê´€ë¦¬</button>
                    <button onclick="changeTab('guests')" class="tab-button w-full text-center py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-users mr-1"></i>í•˜ê° ê´€ë¦¬</button>
                    <button onclick="changeTab('photos')" class="tab-button w-full text-center py-3 px-1 border-b-2 font-medium text-sm"><i class="fas fa-images mr-1"></i>ì‚¬ì§„ì²©</button>
                </nav>
            </div>

            <!-- Content Sections -->
            <main>
                <div id="checklist" class="tab-content"></div>
                <div id="budget" class="tab-content hidden"></div>
                <div id="guests" class="tab-content hidden"></div>
                <div id="photos" class="tab-content hidden"></div>
            </main>
        </div>

        <!-- Modal -->
        <div id="itemModal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
                <form id="modal-form" class="space-y-4"></form>
                <div class="flex justify-end mt-6 space-x-2">
                    <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                    <button id="modal-save-button" onclick="handleModalSave()" class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600">ì €ì¥</button>
                </div>
            </div>
        </div>
        
        <!-- Custom Confirm Modal -->
        <div id="confirmModal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h3 id="confirm-title" class="text-lg font-bold mb-4">í™•ì¸</h3>
                <p id="confirm-message">ì´ í•­ëª©ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div class="flex justify-end mt-6 space-x-2">
                    <button id="confirm-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                    <button id="confirm-ok" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">í™•ì¸</button>
                </div>
            </div>
        </div>

        <!-- Lightbox -->
        <div id="lightbox" class="lightbox hidden">
            <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
            <img class="lightbox-content" id="lightbox-img">
            <a class="lightbox-prev" onclick="showPrevPhoto()">&#10094;</a>
            <a class="lightbox-next" onclick="showNextPhoto()">&#10095;</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script type="module">
        // Firebase SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, setDoc, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- 1. Firebase ì„¤ì • ---
       const firebaseConfig = {
            apiKey: "AIzaSyAGsIe6fQKF1QiUgE3uyeWWNwc4qlzmX0E",
            authDomain: "my-wedding-planner-9ee2e.firebaseapp.com",
            projectId: "my-wedding-planner-9ee2e",
            storageBucket: "my-wedding-planner-9ee2e.firebasestorage.app",
            messagingSenderId: "7609656615",
            appId: "1:7609656615:web:d7d8c7149994bcbccdb502"
        };

        const appId = 'wedding-planner-v2';

        let app, auth, db, storage, userId, currentModal = {};
        let weddingDate = new Date('2026-04-04T13:20:00');
        
        let allChecklistItems = [], allBudgetItems = [], allGuests = [], allPhotos = [];
        
        let currentPhotoIndex = 0;
        let isFirebaseInitialized = false;

        // --- ì‚¬ì§„ì²© ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ---
        let photoViewMode = 'folders'; // 'folders' ë˜ëŠ” 'single_folder'
        let currentFolderName = null;
        let isDeleteSelectionMode = false;
        let photosSelectedForDeletion = new Set();

        const formatNumberWithCommas = (number) => number?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") || '';
        const parseFormattedNumber = (str) => parseInt(String(str).replace(/,/g, ''), 10) || 0;
        window.handleNumberInput = (e) => {
            const input = e.target;
            input.value = formatNumberWithCommas(parseFormattedNumber(input.value));
        };

        const correctPassword = '0719';
        window.checkPassword = function() {
            const input = document.getElementById('password-input');
            if (input.value === correctPassword) {
                document.getElementById('password-gate').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                sessionStorage.setItem('weddingPlannerAuthenticated', 'true');
                if (!isFirebaseInitialized) {
                    initializeFirebase();
                }
            } else {
                document.getElementById('password-error').textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                input.value = '';
                input.focus();
            }
        }

        async function initializeFirebase() {
            if (isFirebaseInitialized) return;
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg"><h2 class="font-bold text-xl">ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨</h2><p class="mt-2">Firebase ì„¤ì • ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ ì•±ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                setLogLevel('debug');
                isFirebaseInitialized = true;
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authentication ready. User ID:", userId);
                        initializeDatePicker();
                        setupSnapshots();
                    } else {
                        userId = null;
                        console.log("User is signed out.");
                    }
                });
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg"><h2 class="font-bold text-xl">ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì˜¤ë¥˜</h2><p class="mt-2">ì˜¤ë¥˜: ${error.message}</p></div>`;
            }
        }

        function initializeDatePicker() {
            const container = document.getElementById('wedding-date-container');
            if (!container) {
                console.error("DatePicker container not found!");
                return;
            }
            flatpickr("#wedding-date-picker", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                defaultDate: weddingDate,
                wrap: true,
                appendTo: container, 
                onChange: async (selectedDates) => { 
                    if(db && userId && selectedDates.length > 0) {
                        await setDoc(doc(db, `artifacts/${appId}/public/data/settings`, "main"), { weddingDate: selectedDates[0] }); 
                    }
                }
            });
        }

        function renderActiveTab() {
            const activeTabButton = document.querySelector('.tab-button.active');
            if (!activeTabButton) return;
            const tabName = activeTabButton.getAttribute('onclick').match(/'([^']+)'/)[1];

            if (tabName === 'checklist') {
                window.renderChecklist(allChecklistItems);
            } else if (tabName === 'budget') {
                window.renderBudget(allBudgetItems);
            } else if (tabName === 'guests') {
                window.renderGuests(allGuests);
            } else if (tabName === 'photos') {
                window.renderPhotos(allPhotos);
            }
        }

        window.changeTab = (tabName) => {
            if (photoViewMode !== 'folders' || isDeleteSelectionMode) {
                exitDeleteMode(false);
                navigateBackToFolders(false);
            }

            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const container = document.getElementById(tabName);
            container.classList.remove('hidden');

            if (!container.innerHTML.trim()) {
                loadTabContent(tabName);
            }

            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`button[onclick="changeTab('${tabName}')"]`).classList.add('active');
            
            renderActiveTab();
        };

        const updateDday = (date) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weddingDay = new Date(date);
            weddingDay.setHours(0, 0, 0, 0);
            const diffTime = weddingDay - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            document.getElementById('d-day-counter').innerHTML = diffDays > 0 ? `ğŸ’ Wedding D-${diffDays}` : (diffDays === 0 ? `â¤ï¸ Happy Wedding Day!` : `ğŸ‰ Married for ${Math.abs(diffDays)} days`);
            document.getElementById('wedding-date-display').textContent = date.toLocaleString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const updateDaysTogether = () => {
            const metDate = new Date('2025-07-19T00:00:00');
            const diffDays = Math.floor((new Date() - metDate) / (1000 * 60 * 60 * 24));
            if (diffDays >= 0) {
                document.getElementById('days-together-counter').innerHTML = `í•¨ê»˜í•œ ì§€ <span class="font-semibold text-pink-500">${diffDays + 1}</span>ì¼ì§¸`;
            }
        };
        
        window.addGuestNameField = () => {
            const container = document.getElementById('guest-names-container');
            const newEntry = document.createElement('div');
            newEntry.className = 'flex items-center mt-1 guest-name-entry';
            newEntry.innerHTML = `
                <input type="text" name="guestName" class="w-full p-2 border rounded" required>
                <button type="button" onclick="this.parentElement.remove()" class="ml-2 text-red-500 hover:text-red-700"><i class="fas fa-minus-circle"></i></button>
            `;
            container.appendChild(newEntry);
            newEntry.querySelector('input').focus();
        };

        window.openModal = (type, mode, item = {}) => {
            currentModal = { type, mode, item };
            const modal = document.getElementById('itemModal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('modal-form');
            form.innerHTML = '';
            const isEdit = mode === 'edit';

            if (type === 'checklist') {
                title.textContent = isEdit ? 'ì²´í¬ë¦¬ìŠ¤íŠ¸ ìˆ˜ì •' : 'ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©';
                form.innerHTML = `<input type="hidden" id="itemId" value="${item.id || ''}">
                    <div><label class="block text-sm font-medium">í•­ëª© ë‚´ìš©</label><input type="text" id="checklistItemText" class="mt-1 w-full p-2 border rounded" value="${item.text || ''}" required></div>
                    <div><label class="block text-sm font-medium">ì¹´í…Œê³ ë¦¬</label><input type="text" id="checklistItemCategory" value="${item.category || ''}" class="mt-1 w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-medium">ë‚ ì§œ</label><input type="text" id="checklistItemDate" value="${item.date || ''}" class="mt-1 w-full p-2 border rounded" placeholder="ë‚ ì§œ ì„ íƒ"></div>
                    <div><label class="block text-sm font-medium">ë©”ëª¨</label><textarea id="checklistItemMemo" class="mt-1 w-full p-2 border rounded" rows="2" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”.">${item.memo || ''}</textarea></div>
                     <div><label class="block text-sm font-medium">ì¥ì†Œ (ì„ íƒ)</label><input type="text" id="checklistItemLocation" placeholder="ì˜ˆ: ì°½ì› ë¦¬ë² ë¼ ì»¨ë²¤ì…˜" class="mt-1 w-full p-2 border rounded" value="${item.location || ''}"></div>
                    `;
                flatpickr("#checklistItemDate", { enableTime: true, dateFormat: "Y-m-d H:i" });
            } else if (type === 'budget') {
                title.textContent = isEdit ? 'ì˜ˆì‚° í•­ëª© ìˆ˜ì •' : 'ìƒˆ ì˜ˆì‚° í•­ëª©';
                form.innerHTML = `
                    <input type="hidden" id="itemId" value="${item.id || ''}">
                    <div><label class="block text-sm font-medium">ì¹´í…Œê³ ë¦¬</label>
                        <select id="budgetCategory" class="mt-1 w-full p-2 border rounded">
                            <option value="ì›¨ë”©í™€">ì›¨ë”©í™€</option>
                            <option value="ì˜ˆë‹¨, ì˜ˆë¬¼">ì˜ˆë‹¨, ì˜ˆë¬¼</option>
                            <option value="ì‹ í˜¼ì—¬í–‰">ì‹ í˜¼ì—¬í–‰</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium">í•­ëª©</label><input type="text" id="budgetItem" value="${item.item || ''}" class="mt-1 w-full p-2 border rounded" required></div>
                    <div><label class="block text-sm font-medium text-blue-600">ì˜ˆìƒ ê¸ˆì•¡</label><div class="mt-1 flex items-center"><button type="button" onclick="adjustBudget('budgetEstimated', -10000)" class="px-3 py-2 border rounded-l-md bg-gray-50">-</button><input type="text" inputmode="numeric" id="budgetEstimated" value="${formatNumberWithCommas(item.estimatedAmount || '')}" oninput="handleNumberInput(event)" class="w-full p-2 border-t border-b text-center" placeholder="ì´ ì˜ˆìƒ ê¸ˆì•¡"><button type="button" onclick="adjustBudget('budgetEstimated', 10000)" class="px-3 py-2 border rounded-r-md bg-gray-50">+</button></div></div>
                    <hr class="my-3">
                    <p class="text-sm font-medium text-pink-600">ì‹¤ì œ ì§€ì¶œ</p>
                    <div><label class="block text-xs font-medium">ì‹¤ì œ ì´ì•¡</label><div class="mt-1 flex items-center"><button type="button" onclick="adjustBudget('budgetTotal', -10000)" class="px-3 py-2 border rounded-l-md bg-gray-50">-</button><input type="text" inputmode="numeric" id="budgetTotal" value="${formatNumberWithCommas(item.totalAmount || 0)}" oninput="handleNumberInput(event)" class="w-full p-2 border-t border-b text-center"><button type="button" onclick="adjustBudget('budgetTotal', 10000)" class="px-3 py-2 border rounded-r-md bg-gray-50">+</button></div></div>
                    <div><label class="block text-xs font-medium">ê³„ì•½ê¸ˆ</label><div class="mt-1 flex items-center"><button type="button" onclick="adjustBudget('budgetDeposit', -10000)" class="px-3 py-2 border rounded-l-md bg-gray-50">-</button><input type="text" inputmode="numeric" id="budgetDeposit" value="${formatNumberWithCommas(item.deposit || 0)}" oninput="handleNumberInput(event)" class="w-full p-2 border-t border-b text-center"><button type="button" onclick="adjustBudget('budgetDeposit', 10000)" class="px-3 py-2 border rounded-r-md bg-gray-50">+</button></div></div>
                    <div><label class="block text-xs font-medium">ì§€ë¶ˆ</label><select id="budgetPayer" class="mt-1 w-full p-2 border rounded"><option value="joint">ê³µë™</option><option value="groom">ë¯¼ì›…</option><option value="bride">ì§€ì€</option></select></div>`;
                if(isEdit) {
                    document.getElementById('budgetPayer').value = item.payer || 'joint';
                    document.getElementById('budgetCategory').value = item.category || 'ê¸°íƒ€';
                }
            } else if (type === 'guest') {
                title.textContent = isEdit ? 'í•˜ê° ì •ë³´ ìˆ˜ì •' : 'ìƒˆ í•˜ê° ì¶”ê°€';
                let formHTML = `
                    <input type="hidden" id="itemId" value="${item.id || ''}">
                    <div><label class="block text-sm font-medium">ì†Œì†</label><select id="guestSide" class="mt-1 w-full p-2 border rounded"><option value="groom">ë¯¼ì›…</option><option value="bride">ì§€ì€</option></select></div>
                    <div><label class="block text-sm font-medium">ê´€ê³„</label><select id="guestRelation" class="mt-1 w-full p-2 border rounded"><option value="family">ê°€ì¡±</option><option value="friend">ì¹œêµ¬</option><option value="coworker">ì§ì¥ë™ë£Œ</option><option value="etc">ê¸°íƒ€</option></select></div>
                    <hr>
                    <div id="guest-names-container" style="max-height: 150px; overflow-y: auto; padding-right: 5px;">
                        <label class="block text-sm font-medium">ì´ë¦„</label>
                        <div class="flex items-center mt-1 guest-name-entry">
                            <input type="text" name="guestName" class="w-full p-2 border rounded" required>
                        </div>
                    </div>
                    <button type="button" onclick="addGuestNameField()" class="mt-2 text-sm text-pink-500 hover:text-pink-700"><i class="fas fa-plus mr-1"></i>ì´ë¦„ ì¶”ê°€</button>
                `;
                if (isEdit) {
                    formHTML = `<input type="hidden" id="itemId" value="${item.id || ''}">
                        <div><label class="block text-sm font-medium">ì´ë¦„</label><input type="text" name="guestName" value="${item.name || ''}" class="mt-1 w-full p-2 border rounded" required></div>
                        <div><label class="block text-sm font-medium">ì†Œì†</label><select id="guestSide" class="mt-1 w-full p-2 border rounded"><option value="groom">ë¯¼ì›…</option><option value="bride">ì§€ì€</option></select></div>
                        <div><label class="block text-sm font-medium">ê´€ê³„</label><select id="guestRelation" class="mt-1 w-full p-2 border rounded"><option value="family">ê°€ì¡±</option><option value="friend">ì¹œêµ¬</option><option value="coworker">ì§ì¥ë™ë£Œ</option><option value="etc">ê¸°íƒ€</option></select></div>`;
                }
                form.innerHTML = formHTML;
                if(isEdit) { 
                    document.getElementById('guestSide').value = item.side; 
                    document.getElementById('guestRelation').value = item.relation; 
                }
            } else if (type === 'photo') {
                title.textContent = 'ì‚¬ì§„ ì˜¬ë¦¬ê¸°';
                const existingFolders = [...new Set(allPhotos.map(p => p.folderName).filter(Boolean))];
                const folderOptions = existingFolders.map(f => `<option value="${f}">${f}</option>`).join('');
                form.innerHTML = `<div><label class="block text-sm font-medium">í´ë” ì„ íƒ</label><select id="photoFolderSelect" class="mt-1 w-full p-2 border rounded"><option value="">ê¸°íƒ€</option>${folderOptions}<option value="_new_">-- ìƒˆ í´ë” ë§Œë“¤ê¸° --</option></select></div><div id="newFolderInputContainer" class="hidden"><label class="block text-sm font-medium">ìƒˆ í´ë” ì´ë¦„</label><input type="text" id="newFolderName" class="mt-1 w-full p-2 border rounded"></div><div><label class="block text-sm font-medium">ì‚¬ì§„ íŒŒì¼ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</label><input type="file" id="photoFileInput" class="mt-1 w-full" accept="image/*" required multiple></div><div id="photo-upload-progress" class="text-sm text-gray-500 hidden"></div>`;
                document.getElementById('photoFolderSelect').addEventListener('change', (e) => {
                    document.getElementById('newFolderInputContainer').classList.toggle('hidden', e.target.value !== '_new_');
                });
            }
            modal.classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('itemModal').classList.add('hidden');

        window.adjustBudget = (inputId, amount) => {
            const input = document.getElementById(inputId);
            if (input) { 
                let currentValue = parseFormattedNumber(input.value); 
                currentValue += amount; 
                if (currentValue < 0) currentValue = 0; 
                input.value = formatNumberWithCommas(currentValue); 
            }
        };
        
        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('confirmModal');
            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');
            
            document.getElementById('confirm-message').textContent = message;
            
            if (message.includes('ì¤‘ë³µëœ í•˜ê°')) {
                okBtn.textContent = 'ì¶”ê°€';
                cancelBtn.textContent = 'ì·¨ì†Œ';
            } else {
                okBtn.textContent = 'ì‚­ì œ';
                 cancelBtn.textContent = 'ì·¨ì†Œ';
            }

            confirmModal.classList.remove('hidden');
            
            const close = () => {
                confirmModal.classList.add('hidden');
                okBtn.onclick = null;
                cancelBtn.onclick = null;
            };
            okBtn.onclick = () => {
                close();
                onConfirm();
            };
            cancelBtn.onclick = close;
        }

        window.handleModalSave = () => { currentModal.type === 'photo' ? handlePhotoUpload() : handleFormSubmit(); }

        async function handlePhotoUpload() {
            if (!db || !storage || !userId) { console.error("DB/Storage not ready or user not authenticated."); return; }
            const fileInput = document.getElementById('photoFileInput');
            const files = fileInput.files;
            if (files.length === 0) {
                showConfirm("ì‚¬ì§„ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", () => {});
                return;
            }
            
            let folderName = document.getElementById('photoFolderSelect').value;
            if (folderName === '_new_') {
                folderName = document.getElementById('newFolderName').value.trim();
                if (!folderName) {
                    showConfirm("ìƒˆ í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", () => {});
                    return;
                }
            }

            const progressDiv = document.getElementById('photo-upload-progress');
            progressDiv.classList.remove('hidden');
            const saveButton = document.getElementById('modal-save-button');
            
            saveButton.disabled = true;
            saveButton.textContent = 'ì—…ë¡œë“œ ì¤‘...';

            const totalFiles = files.length;
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < totalFiles; i++) {
                const file = files[i];
                progressDiv.textContent = `(${i + 1}/${totalFiles}) "${file.name}" ì—…ë¡œë“œ ì¤‘...`;
                const storageRef = ref(storage, `photos/${Date.now()}_${file.name}`);
                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    await addDoc(collection(db, `artifacts/${appId}/public/data/photos`), { 
                        url: downloadURL, 
                        storagePath: snapshot.ref.fullPath, 
                        folderName: folderName || null, 
                        createdAt: new Date() 
                    });
                    successCount++;
                } catch (error) { 
                    console.error(`"${file.name}" Upload failed`, error); 
                    errorCount++;
                }
            }
            
            saveButton.disabled = false;
            saveButton.textContent = 'ì €ì¥';

            if(errorCount > 0) {
                progressDiv.textContent = `âœ… ${successCount}ê°œ ì„±ê³µ, âŒ ${errorCount}ê°œ ì‹¤íŒ¨`;
            } else {
                progressDiv.textContent = `âœ… ì´ ${successCount}ê°œ ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ!`;
            }

            setTimeout(() => closeModal(), 2000);
        }

        window.handleFormSubmit = async () => {
            if (!db || !userId) { alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤€ë¹„ ì•ˆë¨"); return; }
            const { type, mode, item } = currentModal;
            const id = document.getElementById('itemId')?.value || item.id;

            try {
                if (type === 'checklist') {
                    const data = {
                        text: document.getElementById('checklistItemText').value.trim(),
                        category: document.getElementById('checklistItemCategory').value.trim() || 'ê¸°íƒ€',
                        date: document.getElementById('checklistItemDate').value.trim(),
                        memo: document.getElementById('checklistItemMemo').value.trim(),
                        location: document.getElementById('checklistItemLocation').value.trim()
                    };
                    if (!data.text) { alert('í•­ëª© ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                    
                    if (mode === 'edit' && id) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/checklists`, id), data);
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/checklists`), { ...data, order: Date.now(), createdAt: new Date(), completed: false });
                    }
                } else if (type === 'budget') {
                    const data = {
                        category: document.getElementById('budgetCategory').value,
                        item: document.getElementById('budgetItem').value.trim(),
                        estimatedAmount: parseFormattedNumber(document.getElementById('budgetEstimated').value),
                        totalAmount: parseFormattedNumber(document.getElementById('budgetTotal').value),
                        deposit: parseFormattedNumber(document.getElementById('budgetDeposit').value),
                        payer: document.getElementById('budgetPayer').value
                    };
                    if (!data.item) { alert('í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

                    if (mode === 'edit' && id) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/budgets`, id), data);
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/budgets`), { ...data, createdAt: new Date() });
                    }
                } else if (type === 'guest') {
                    if (mode === 'edit' && id) {
                        const data = {
                            name: document.querySelector('input[name="guestName"]').value.trim(),
                            side: document.getElementById('guestSide').value,
                            relation: document.getElementById('guestRelation').value,
                        };
                        if (!data.name) { alert('í•˜ê° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

                        const isDuplicate = allGuests.some(g => g.id !== id && g.name === data.name);
                        const processUpdate = async () => {
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/guests`, id), data);
                            closeModal();
                        };
                        if (isDuplicate) {
                            showConfirm('ì¤‘ë³µëœ í•˜ê°ì´ ì¡´ì¬í•©ë‹ˆë‹¤. í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.', processUpdate);
                            return; 
                        }
                        await processUpdate();
                    } else { 
                        const nameInputs = document.querySelectorAll('input[name="guestName"]');
                        const names = [...nameInputs].map(input => input.value.trim()).filter(Boolean);
                        if (names.length === 0) { alert("í•˜ê° ì´ë¦„ì„ í•œ ëª… ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                        
                        const side = document.getElementById('guestSide').value;
                        const relation = document.getElementById('guestRelation').value;
                        const duplicates = names.filter(name => allGuests.some(g => g.name === name));

                        const processSave = async () => {
                            const batch = writeBatch(db);
                            names.forEach(name => {
                                const docRef = doc(collection(db, `artifacts/${appId}/public/data/guests`));
                                batch.set(docRef, { name, side, relation, createdAt: new Date() });
                            });
                            await batch.commit();
                            closeModal();
                        };

                        if (duplicates.length > 0) {
                            showConfirm(`ì¤‘ë³µëœ í•˜ê°(${duplicates.join(', ')})ì´ ì¡´ì¬í•©ë‹ˆë‹¤. í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.`, processSave);
                            return; 
                        }
                        await processSave();
                    }
                    return;
                }
            } catch (e) {
                console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ", e);
            }
            closeModal();
        };
        
        window.deleteItem = async (collectionName, id) => {
            const message = collectionName === 'guests' ? 'ì´ í•˜ê°ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            showConfirm(message, async () => {
                if (!db || !userId) { console.error("DB not ready or user not authenticated."); return; }
                try {
                    if (collectionName === 'photos') {
                        const photoToDelete = allPhotos.find(p => p.id === id);
                        if (photoToDelete && photoToDelete.storagePath) {
                            await deleteObject(ref(storage, photoToDelete.storagePath));
                        }
                    }
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, id));
                } catch (error) {
                    console.error("Error deleting item:", error);
                }
            });
        };
        
        window.editBudgetItem = (id) => { const item = allBudgetItems.find(i => i.id === id); if(item) openModal('budget', 'edit', item); };
        window.editGuestItem = (id) => { const item = allGuests.find(i => i.id === id); if(item) openModal('guest', 'edit', item); };
        
        const lightbox = document.getElementById('lightbox');
        let touchStartX = 0;
        const handleTouchStart = (e) => { touchStartX = e.changedTouches[0].screenX; };
        const handleTouchEnd = (e) => {
            let touchEndX = e.changedTouches[0].screenX;
            if (touchStartX - touchEndX > 50) { showNextPhoto(); } 
            else if (touchEndX - startX > 50) { showPrevPhoto(); }
        };

        window.openLightbox = (index) => {
            if (isDeleteSelectionMode) return;
            
            const currentVisiblePhotos = (photoViewMode === 'single_folder' && currentFolderName)
                ? allPhotos.filter(p => (p.folderName || 'ê¸°íƒ€') === currentFolderName)
                : allPhotos;

            const photoToOpen = allPhotos[index];
            currentPhotoIndex = currentVisiblePhotos.findIndex(p => p.id === photoToOpen.id);
            if (currentPhotoIndex === -1) currentPhotoIndex = 0;

            document.getElementById('lightbox-img').src = currentVisiblePhotos[currentPhotoIndex].url;
            lightbox.classList.remove('hidden');
            lightbox.addEventListener('touchstart', handleTouchStart, { passive: true });
            lightbox.addEventListener('touchend', handleTouchEnd, { passive: true });
        };

        window.closeLightbox = () => {
            lightbox.classList.add('hidden');
            lightbox.removeEventListener('touchstart', handleTouchStart);
            lightbox.removeEventListener('touchend', handleTouchEnd);
        };
        
        const updateLightboxImage = () => {
             const currentVisiblePhotos = (photoViewMode === 'single_folder' && currentFolderName)
                ? allPhotos.filter(p => (p.folderName || 'ê¸°íƒ€') === currentFolderName)
                : allPhotos;
            if (currentVisiblePhotos.length > 0) {
                 document.getElementById('lightbox-img').src = currentVisiblePhotos[currentPhotoIndex].url;
            }
        }

        window.showNextPhoto = () => {
            const currentVisiblePhotos = (photoViewMode === 'single_folder' && currentFolderName)
                ? allPhotos.filter(p => (p.folderName || 'ê¸°íƒ€') === currentFolderName)
                : allPhotos;
            if (currentVisiblePhotos.length === 0) return;
            currentPhotoIndex = (currentPhotoIndex + 1) % currentVisiblePhotos.length;
            updateLightboxImage();
        };

        window.showPrevPhoto = () => {
            const currentVisiblePhotos = (photoViewMode === 'single_folder' && currentFolderName)
                ? allPhotos.filter(p => (p.folderName || 'ê¸°íƒ€') === currentFolderName)
                : allPhotos;
            if (currentVisiblePhotos.length === 0) return;
            currentPhotoIndex = (currentPhotoIndex - 1 + currentVisiblePhotos.length) % currentVisiblePhotos.length;
            updateLightboxImage();
        };

        function loadTabContent(tabName) {
            const container = document.getElementById(tabName);
            if (tabName === 'checklist') container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-md"><h2 class="text-xl font-bold text-pink-500 mb-4">ì¤€ë¹„ ëª©ë¡</h2><div id="checklist-container"></div></div>`;
            else if (tabName === 'budget') container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-pink-500">ì˜ˆì‚° ê´€ë¦¬</h2><button onclick="openModal('budget', 'add')" class="bg-pink-500 text-white px-3 py-2 rounded-lg hover:bg-pink-600 text-sm"><i class="fas fa-plus mr-1"></i>í•­ëª© ì¶”ê°€</button></div><div id="budget-list"></div><div id="grand-total" class="mt-6"></div></div>`;
            else if (tabName === 'guests') container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-pink-500">í•˜ê° ëª…ë‹¨</h2><button onclick="openModal('guest', 'add')" class="bg-pink-500 text-white px-3 py-2 rounded-lg hover:bg-pink-600 text-sm"><i class="fas fa-user-plus mr-1"></i>í•˜ê° ì¶”ê°€</button></div><div class="space-y-6"><div id="groom-container"></div><div id="bride-container"></div></div></div>`;
            else if (tabName === 'photos') {
                container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-md">
                    <div id="photo-header" class="flex justify-between items-center mb-4">
                    </div>
                    <div id="photo-gallery-container" class="space-y-8"></div>
                </div>`;
            }
        }

        function setupSnapshots() {
            if (!db) return;
            onSnapshot(doc(db, `artifacts/${appId}/public/data/settings`, "main"), (docSnap) => {
                if (docSnap.exists() && docSnap.data().weddingDate) { 
                    weddingDate = docSnap.data().weddingDate.toDate(); 
                }
                updateDday(weddingDate);
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/checklists`), (snap) => {
                allChecklistItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderActiveTab();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/budgets`), (snap) => {
                allBudgetItems = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                renderActiveTab();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/guests`), (snap) => {
                allGuests = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                renderActiveTab();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/photos`), (snap) => {
                allPhotos = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderActiveTab();
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('weddingPlannerAuthenticated') === 'true') {
                document.getElementById('password-gate').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initializeFirebase();
            }
            document.getElementById('password-input').addEventListener('keyup', (event) => { if (event.key === "Enter") { event.preventDefault(); checkPassword(); } });
            
            updateDday(weddingDate);
            updateDaysTogether();
            setInterval(updateDaysTogether, 1000 * 60 * 60);
            loadTabContent('checklist');
        });

        // --- ë Œë”ë§ í•¨ìˆ˜ë“¤ ---
        window.renderBudget = function(items) {
            const list = document.getElementById('budget-list');
            const grandTotalDiv = document.getElementById('grand-total');
            if (!list || !grandTotalDiv) return;

            list.innerHTML = '';
            list.className = 'space-y-3';
            
            const totals = {
                all: { estimated: 0, actual: 0 },
                groom: { estimated: 0, actual: 0 },
                bride: { estimated: 0, actual: 0 },
            };

            items.forEach(item => {
                const estimated = item.estimatedAmount || 0;
                const actual = item.totalAmount || 0;
                
                totals.all.estimated += estimated;
                totals.all.actual += actual;

                if (item.payer === 'groom') {
                    totals.groom.estimated += estimated;
                    totals.groom.actual += actual;
                } else if (item.payer === 'bride') {
                    totals.bride.estimated += estimated;
                    totals.bride.actual += actual;
                } else { // 'joint' or undefined
                    totals.groom.estimated += estimated / 2;
                    totals.groom.actual += actual / 2;
                    totals.bride.estimated += estimated / 2;
                    totals.bride.actual += actual / 2;
                }
            });

            const categoryOrder = ['ì›¨ë”©í™€', 'ì˜ˆë‹¨, ì˜ˆë¬¼', 'ì‹ í˜¼ì—¬í–‰', 'ê¸°íƒ€'];
            const grouped = items.reduce((acc, item) => {
                const key = item.category || 'ê¸°íƒ€';
                if (!acc[key]) acc[key] = [];
                acc[key].push(item);
                return acc;
            }, {});

            categoryOrder.forEach(category => {
                if (grouped[category]) {
                    const details = document.createElement('details');
                    details.className = 'bg-gray-50 rounded-lg';

                    const summary = document.createElement('summary');
                    summary.className = 'p-3 font-semibold cursor-pointer flex items-center guest-summary';
                    const itemCount = grouped[category].length;
                    
                    const categoryTotalEstimated = grouped[category].reduce((sum, item) => sum + (item.estimatedAmount || 0), 0);
                    const categoryTotalActual = grouped[category].reduce((sum, item) => sum + (item.totalAmount || 0), 0);

                    summary.innerHTML = `
                        <span class="flex-grow text-lg">${category} (${itemCount})</span>
                        <div class="text-sm text-right">
                            <p>ì˜ˆìƒ: ${formatNumberWithCommas(categoryTotalEstimated)}ì›</p>
                            <p>ì§€ì¶œ: ${formatNumberWithCommas(categoryTotalActual)}ì›</p>
                        </div>
                    `;
                    
                    const itemListContainer = document.createElement('div');
                    itemListContainer.className = 'px-3 pb-3 pt-1 space-y-2';
                    
                    grouped[category].forEach(item => {
                        const { estimatedAmount: estimated = 0, totalAmount: actual = 0, deposit = 0 } = item;
                        const balance = actual - deposit;
                        const payerBadge = { groom: 'bg-sky-100 text-sky-800', bride: 'bg-rose-100 text-rose-800', joint: 'bg-green-100 text-green-800'}[item.payer];
                        const payerText = { groom: 'ë¯¼ì›…', bride: 'ì§€ì€', joint: 'ê³µë™'}[item.payer] || 'ê³µë™';
                        const div = document.createElement('div');
                        div.className = 'p-3 bg-white rounded-lg shadow-sm';
                        div.innerHTML = `<div class="flex justify-between items-start"><div class="item-content flex-grow" onclick="editBudgetItem('${item.id}')"><p class="font-semibold">${item.item}</p><div class="mt-2 text-xs text-gray-600 space-y-1"><p><b>ì˜ˆìƒ:</b> ${formatNumberWithCommas(estimated)}ì›</p><p><b>ì‹¤ì œ:</b> ${formatNumberWithCommas(actual)}ì› (ê³„ì•½ê¸ˆ: ${formatNumberWithCommas(deposit)} / ì”ê¸ˆ: ${formatNumberWithCommas(balance)})</p></div></div><div class="text-right ml-2 flex flex-col items-end flex-shrink-0"><div class="mb-2"><span class="text-xs font-semibold px-2 py-1 rounded-full ${payerBadge}">${payerText}</span></div><button onclick="event.stopPropagation(); deleteItem('budgets', '${item.id}')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt fa-sm"></i></button></div></div>`;
                        itemListContainer.appendChild(div);
                    });

                    details.appendChild(summary);
                    details.appendChild(itemListContainer);
                    list.appendChild(details);
                }
            });

            grandTotalDiv.innerHTML = `
                <details class="text-right text-lg cursor-pointer">
                    <summary class="list-none">
                        <p>ì´ ì˜ˆìƒ: <span class="font-bold">${formatNumberWithCommas(totals.all.estimated)}ì›</span></p>
                        <p>ì´ ì§€ì¶œ: <span class="font-bold text-pink-600">${formatNumberWithCommas(totals.all.actual)}ì›</span></p>
                        <p class="text-xs text-gray-500 mt-1">(ìì„¸íˆ ë³´ë ¤ë©´ í´ë¦­)</p>
                    </summary>
                    <div class="mt-4 p-4 bg-gray-100 rounded-lg text-sm text-left shadow-inner">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="font-semibold text-sky-600">ğŸ¤µ ë¯¼ì›…</p>
                                <p>ì˜ˆìƒ: ${formatNumberWithCommas(totals.groom.estimated)}ì›</p>
                                <p>ì§€ì¶œ: ${formatNumberWithCommas(totals.groom.actual)}ì›</p>
                            </div>
                            <div>
                                <p class="font-semibold text-rose-500">ğŸ‘° ì§€ì€</p>
                                <p>ì˜ˆìƒ: ${formatNumberWithCommas(totals.bride.estimated)}ì›</p>
                                <p>ì§€ì¶œ: ${formatNumberWithCommas(totals.bride.actual)}ì›</p>
                            </div>
                        </div>
                    </div>
                </details>`;
        };
        window.renderChecklist = function(items) {
            const container = document.getElementById('checklist-container');
            if (!container) return;
            container.innerHTML = '';
            container.className = 'space-y-3';
            const grouped = items.reduce((acc, item) => { const key = item.category || 'ê¸°íƒ€'; if (!acc[key]) acc[key] = []; acc[key].push(item); return acc; }, {});
            
            Object.keys(grouped).sort().forEach(category => {
                const details = document.createElement('details');
                details.className = 'bg-gray-50 rounded-lg';

                const summary = document.createElement('summary');
                summary.className = 'p-3 font-semibold cursor-pointer flex items-center guest-summary';
                const itemCount = grouped[category].length;

                summary.innerHTML = `
                    <span class="flex-grow text-lg">${category} (${itemCount})</span>
                    <button onclick="event.preventDefault(); event.stopPropagation(); openModal('checklist', 'add', { category: '${category}' })" class="text-pink-500 hover:text-pink-700 text-xl ml-4">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                `;

                const listContainer = document.createElement('div');
                listContainer.className = 'px-3 pb-3 pt-1 space-y-2';

                grouped[category].sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'draggable flex items-center justify-between p-3 bg-white rounded-lg shadow-sm';
                    div.setAttribute('draggable', true);
                    div.dataset.id = item.id;
                    div.dataset.order = item.order;
                    
                    let detailsHTML = '';
                    if (item.date) detailsHTML += `<p class="text-xs text-gray-500 ${item.completed ? 'completed' : ''}"><i class="far fa-calendar-alt fa-fw mr-1"></i>${item.date}</p>`;
                    if (item.memo) detailsHTML += `<p class="text-xs text-gray-500 ${item.completed ? 'completed' : ''}"><i class="far fa-sticky-note fa-fw mr-1"></i>${item.memo}</p>`;
                    if (item.location) detailsHTML += `<a href="https://map.naver.com/p/search/${encodeURIComponent(item.location)}" target="_blank" class="text-xs text-blue-500 hover:underline ${item.completed ? 'completed' : ''}" onclick="event.stopPropagation();"><i class="fas fa-map-marker-alt fa-fw mr-1"></i>${item.location}</a>`;
                    
                    div.innerHTML = `<div class="flex items-center flex-grow"><i class="fas fa-grip-vertical text-gray-300 mr-3 handle"></i><input type="checkbox" id="check-${item.id}" class="h-5 w-5 rounded border-gray-300 text-pink-600 focus:ring-pink-500" ${item.completed ? 'checked' : ''}><div class="ml-3 flex-grow item-content"><p class="${item.completed ? 'completed' : ''}">${item.text}</p><div class="mt-1 space-y-1">${detailsHTML}</div></div></div><button onclick="deleteItem('checklists', '${item.id}')" class="ml-2 text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt fa-sm"></i></button>`;
                    
                    div.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                        if (db && userId) {
                            updateDoc(doc(db, `artifacts/${appId}/public/data/checklists`, item.id), { completed: e.target.checked });
                        }
                    });
                    div.querySelector('.item-content').addEventListener('click', () => openModal('checklist', 'edit', item));
                    
                    let draggedItem = null;
                    div.addEventListener('dragstart', (e) => { draggedItem = div; setTimeout(() => div.classList.add('dragging'), 0); });
                    div.addEventListener('dragend', () => div.classList.remove('dragging'));
                    listContainer.addEventListener('dragover', e => e.preventDefault());
                    listContainer.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        if (!draggedItem || !db || !userId) return;
                        const afterElement = [...listContainer.querySelectorAll('.draggable:not(.dragging)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element;
                        const siblings = Array.from(listContainer.querySelectorAll('.draggable'));
                        const dropIndex = afterElement ? siblings.indexOf(afterElement) : siblings.length;
                        const prevOrder = siblings[dropIndex - 1] ? parseFloat(siblings[dropIndex - 1].dataset.order) : 0;
                        const nextOrder = siblings[dropIndex] ? parseFloat(siblings[dropIndex].dataset.order) : Date.now();
                        const newOrder = (prevOrder + nextOrder) / 2;
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/checklists`, draggedItem.dataset.id), { order: newOrder });
                        draggedItem = null;
                    });
                    listContainer.appendChild(div);
                });

                details.appendChild(summary);
                details.appendChild(listContainer);
                container.appendChild(details);
            });
        };
        window.renderGuests = function(items) {
            const containerMap = { 
                groom: document.getElementById('groom-container'), 
                bride: document.getElementById('bride-container') 
            };
            if (!containerMap.groom || !containerMap.bride) return;

            containerMap.groom.innerHTML = ''; 
            containerMap.bride.innerHTML = '';
            
            const relationText = { family: 'ê°€ì¡±', friend: 'ì¹œêµ¬', coworker: 'ì§ì¥ë™ë£Œ', etc: 'ê¸°íƒ€' };

            const groupedBySide = items.reduce((acc, item) => {
                const side = item.side || 'groom';
                if (!acc[side]) acc[side] = [];
                acc[side].push(item);
                return acc;
            }, { groom: [], bride: [] });

            for (const side of ['groom', 'bride']) {
                const sideContainer = containerMap[side];
                const sideGuests = groupedBySide[side];
                const sideTitle = side === 'groom' ? `ğŸ¤µ ë¯¼ì›…ì¸¡ (${sideGuests.length}ëª…)` : `ğŸ‘° ì§€ì€ì¸¡ (${sideGuests.length}ëª…)`;
                const sideColor = side === 'groom' ? 'text-sky-600' : 'text-rose-500';

                const sideDetails = document.createElement('details');
                sideDetails.innerHTML = `<summary class="text-lg font-semibold mb-2 ${sideColor} cursor-pointer flex justify-between items-center guest-summary"><h3>${sideTitle}</h3></summary>`;
                
                const relationListContainer = document.createElement('div');
                relationListContainer.className = 'space-y-3 pl-4';
                
                const groupedByRelation = sideGuests.reduce((acc, item) => {
                    const relation = item.relation || 'etc';
                    if (!acc[relation]) acc[relation] = [];
                    acc[relation].push(item);
                    return acc;
                }, {});

                Object.keys(relationText).forEach(relationKey => {
                    if (groupedByRelation[relationKey]) {
                        const guestsInRelation = groupedByRelation[relationKey];
                        const details = document.createElement('details');
                        details.className = 'bg-gray-50 rounded-lg';
                        
                        const summary = document.createElement('summary');
                        summary.className = 'p-3 font-semibold cursor-pointer flex justify-between items-center guest-summary';
                        summary.innerHTML = `<span>${relationText[relationKey]} (${guestsInRelation.length}ëª…)</span>`;
                        
                        const listDiv = document.createElement('div');
                        listDiv.className = 'px-3 pb-3 space-y-2';

                        guestsInRelation.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'p-2 bg-white rounded flex justify-between items-center';
                            div.innerHTML = `<span class="item-content flex-grow">${item.name}</span>
                                            <div class="space-x-2">
                                                <button onclick="editGuestItem('${item.id}')" class="text-gray-400 hover:text-blue-500"><i class="fas fa-pen fa-sm"></i></button>
                                                <button onclick="deleteItem('guests', '${item.id}')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt fa-sm"></i></button>
                                            </div>`;
                            listDiv.appendChild(div);
                        });

                        details.appendChild(summary);
                        details.appendChild(listDiv);
                        relationListContainer.appendChild(details);
                    }
                });
                sideDetails.appendChild(relationListContainer);
                sideContainer.appendChild(sideDetails);
            }
        };

        // --- ì‚¬ì§„ì²© ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
        
        function updatePhotoHeader() {
            const header = document.getElementById('photo-header');
            if (!header) return;
            
            let title = 'ìš°ë¦¬ì˜ ì¶”ì–µ';
            let buttons = `<button onclick="enterDeleteMode()" class="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 text-sm"><i class="fas fa-trash-alt mr-1"></i>ì‚­ì œ</button>
                           <button id="add-photo-btn" onclick="openModal('photo', 'add')" class="bg-pink-500 text-white px-3 py-2 rounded-lg hover:bg-pink-600 text-sm ml-2"><i class="fas fa-upload mr-1"></i>ì‚¬ì§„ ì˜¬ë¦¬ê¸°</button>`;

            if (isDeleteSelectionMode) {
                const selectedCount = photosSelectedForDeletion.size;
                title = `${selectedCount}ê°œ ì‚¬ì§„ ì„ íƒë¨`;
                buttons = `<button onclick="exitDeleteMode(true)" class="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 text-sm">ì·¨ì†Œ</button>
                           <button onclick="deleteSelectedPhotos()" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm ml-2" ${selectedCount === 0 ? 'disabled' : ''}><i class="fas fa-trash-alt mr-1"></i>ì„ íƒ ì‚­ì œ</button>`;
            } else if (photoViewMode === 'single_folder') {
                title = currentFolderName;
                buttons = `<button onclick="navigateBackToFolders(true)" class="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 text-sm"><i class="fas fa-arrow-left mr-1"></i>ë’¤ë¡œ</button>
                           <button onclick="enterDeleteMode()" class="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 text-sm ml-2"><i class="fas fa-trash-alt mr-1"></i>ì‚­ì œ</button>
                           <button id="add-photo-btn" onclick="openModal('photo', 'add')" class="bg-pink-500 text-white px-3 py-2 rounded-lg hover:bg-pink-600 text-sm ml-2"><i class="fas fa-upload mr-1"></i>ì‚¬ì§„ ì˜¬ë¦¬ê¸°</button>`;
            }

            header.innerHTML = `<h2 class="text-xl font-bold text-pink-500">${title}</h2><div class="space-x-2">${buttons}</div>`;
        }

        window.navigateToFolder = (folderName) => {
            photoViewMode = 'single_folder';
            currentFolderName = folderName;
            renderPhotos(allPhotos);
        };

        window.navigateBackToFolders = (render = true) => {
            photoViewMode = 'folders';
            currentFolderName = null;
            if (render) renderPhotos(allPhotos);
        };

        window.enterDeleteMode = () => {
            isDeleteSelectionMode = true;
            photosSelectedForDeletion.clear();
            renderPhotos(allPhotos);
        };

        window.exitDeleteMode = (render = true) => {
            isDeleteSelectionMode = false;
            photosSelectedForDeletion.clear();
            if (render) renderPhotos(allPhotos);
        };

        window.togglePhotoSelection = (photoId) => {
            const photoDiv = document.querySelector(`[data-photo-id="${photoId}"]`);
            if (photosSelectedForDeletion.has(photoId)) {
                photosSelectedForDeletion.delete(photoId);
                photoDiv.querySelector('.photo-selection-overlay')?.remove();
            } else {
                photosSelectedForDeletion.add(photoId);
                const overlay = document.createElement('div');
                overlay.className = 'photo-selection-overlay';
                overlay.innerHTML = `<i class="fas fa-check-circle text-4xl text-pink-500"></i>`;
                photoDiv.appendChild(overlay);
            }
            updatePhotoHeader();
        };

        window.deleteSelectedPhotos = async () => {
            const count = photosSelectedForDeletion.size;
            if (count === 0) return;

            showConfirm(`${count}ê°œì˜ ì‚¬ì§„ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                if (!db || !userId) { console.error("DB not ready."); return; }

                const batch = writeBatch(db);
                const deletePromises = [];

                photosSelectedForDeletion.forEach(id => {
                    const photoToDelete = allPhotos.find(p => p.id === id);
                    if (photoToDelete) {
                        batch.delete(doc(db, `artifacts/${appId}/public/data/photos`, id));
                        if (photoToDelete.storagePath) {
                            deletePromises.push(deleteObject(ref(storage, photoToDelete.storagePath)));
                        }
                    }
                });

                try {
                    await batch.commit();
                    await Promise.all(deletePromises);
                    console.log(`${count} photos deleted successfully.`);
                } catch (error) {
                    console.error("Error deleting selected photos:", error);
                } finally {
                    exitDeleteMode(true);
                }
            });
        };
        
        const handlePhotoInteraction = (e, photo, originalIndex) => {
            e.preventDefault();
            if (isDeleteSelectionMode) {
                togglePhotoSelection(photo.id);
                return;
            }
            openLightbox(originalIndex);
        };

        window.renderPhotos = function(items) {
            const container = document.getElementById('photo-gallery-container');
            if (!container) return;
            
            container.innerHTML = '';
            updatePhotoHeader();

            if (items.length === 0 && photoViewMode === 'folders') {
                container.innerHTML = '<p class="text-center text-gray-500">ì•„ì§ ì‚¬ì§„ì´ ì—†ì–´ìš”. ì²« ì‚¬ì§„ì„ ì˜¬ë ¤ë³´ì„¸ìš”!</p>';
                return;
            }

            if (photoViewMode === 'folders') {
                renderAllFoldersView(items, container);
            } else {
                renderSingleFolderView(items, container);
            }
        };

        function renderAllFoldersView(items, container) {
            const groupedByFolder = items.reduce((acc, photo) => { const folder = photo.folderName || 'ê¸°íƒ€'; if (!acc[folder]) acc[folder] = []; acc[folder].push(photo); return acc; }, {});
            const sortedFolders = Object.keys(groupedByFolder).sort((a, b) => { if (a === 'ê¸°íƒ€') return 1; if (b === 'ê¸°íƒ€') return -1; return a.localeCompare(b); });
            
            sortedFolders.forEach(folderName => {
                const photosInFolder = groupedByFolder[folderName];
                const folderDiv = document.createElement('div');
                folderDiv.className = "cursor-pointer";
                folderDiv.onclick = () => navigateToFolder(folderName);

                const photoPreviews = photosInFolder.slice(0, 3).map(photo => 
                    `<div class="relative aspect-square bg-gray-100 rounded-lg overflow-hidden">
                        <img src="${photo.url}" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x400/FFFBF7/D98BA0?text=Error';">
                    </div>`
                ).join('');

                folderDiv.innerHTML = `
                    <div class="flex justify-between items-center border-b pb-2 mb-3">
                        <h3 class="text-xl font-semibold text-gray-700">${folderName}</h3>
                        <span class="text-sm font-normal text-gray-500">${photosInFolder.length}ì¥ ></span>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-3 gap-2">${photoPreviews}</div>`;
                container.appendChild(folderDiv);
            });
        }

        function renderSingleFolderView(items, container) {
            const photosInFolder = items.filter(p => (p.folderName || 'ê¸°íƒ€') === currentFolderName);
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-3 sm:grid-cols-4 gap-2';

            if(photosInFolder.length === 0) {
                navigateBackToFolders(true);
                return;
            }

            photosInFolder.forEach(photo => {
                const originalIndex = allPhotos.findIndex(p => p.id === photo.id);
                const photoWrapper = document.createElement('div');
                photoWrapper.className = "relative aspect-square bg-gray-100 rounded-lg overflow-hidden group cursor-pointer";
                photoWrapper.dataset.photoId = photo.id;
                
                photoWrapper.innerHTML = `<img src="${photo.url}" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x400/FFFBF7/D98BA0?text=Error';">`;
                
                if (isDeleteSelectionMode && photosSelectedForDeletion.has(photo.id)) {
                    const overlay = document.createElement('div');
                    overlay.className = 'photo-selection-overlay';
                    overlay.innerHTML = `<i class="fas fa-check-circle text-4xl text-pink-500"></i>`;
                    photoWrapper.appendChild(overlay);
                }

                photoWrapper.addEventListener('click', (e) => handlePhotoInteraction(e, photo, originalIndex));
                
                grid.appendChild(photoWrapper);
            });
            container.appendChild(grid);
        }
    </script>
</body>
</html>

