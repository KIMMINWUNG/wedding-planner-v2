<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D98BA0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="웨딩플래너">
    <title>민웅 ❤️ 지은 웨딩 플래너</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik05NiA0OEMxMTcuNTk5IDQ4IDEzNSA2NS40MDEgMTM1IDg3QzEzNSAxMDguNTk5IDExNy41OTkgMTI2IDk2IDEyNkM3NC40MDEgMTI2IDU3IDEwOC41OTkgNTcgODdDNTcgNjUuNDAxIDc0LjQwMSA0OCA5NiA0OFoiIGZpbGw9IndoaXRlIiBmaWxsLW9wYWNpdHk9IjAuOSIvPgo8cGF0aCBkPSJNMTM1IDg3SDE0N1Y5OUgxMzVWODdaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjkiLz4KPHBhdGggZD0iTTQ1IDg3SDU3Vjk5SDQ1Vjg3WiIgZmlsbD0id2hpdGUiIGZpbGwtb3BhY2l0eT0iMC45Ii8+CjxwYXRoIGQ9Ik0xMTQgMTE3SDEyNlYxMjlIMTE0VjExN1oiIGZpbGw9IndoaXRlIiBmaWxsLW9wYWNpdHk9IjAuOSIvPgo8cGF0aCBkPSJNNjYgMTE3SDc4VjEyOUg2NlYxMTdaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjkiLz4KPHBhdGggZD0iTTk2IDE0MUM3NC40MDEgMTQxIDU3IDEyMy41OTkgNTcgMTAySDY5QzY5IDExMi41MjMgNzcuNDc3IDEyMSA4OCAxMjFIOThDMTA4LjUyMyAxMjEgMTE3IDExMi41MjMgMTE3IDEwMkgxMjlDMTI5IDEyMy41OTkgMTExLjU5OSAxNDEgOTYgMTQxWiIgZmlsbD0id2hpdGUiIGZpbGwtb3BhY2l0eT0iMC45Ii8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MF9saW5lYXJfMV8xIiB4MT0iMCIgeTE9IjAiIHgyPSIxOTIiIHkyPSIxOTIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iI0Q5OEJBMCIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNFNkM4NkYiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4K">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfMSkiLz4KPHBhdGggZD0iTTE2IDhDMjEuNTIzIDggMjYgMTIuNDc3IDI2IDE4QzI2IDIzLjUyMyAyMS41MjMgMjggMTYgMjhDMTAuNDc3IDI4IDYgMjMuNTIzIDYgMThDNiAxMi40NzcgMTAuNDc3IDggMTYgOFoiIGZpbGw9IndoaXRlIiBmaWxsLW9wYWNpdHk9IjAuOSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfMSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjRDk4QkEwIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI0U2QzhGRiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'wedding-pink': '#D98BA0',
                        'wedding-pink-light': '#F4E6EA',
                        'wedding-pink-dark': '#C67A95',
                        'wedding-cream': '#FFFBF7',
                        'wedding-gold': '#E6C86F'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Root variables for consistent theming */
        :root {
            --wedding-pink: #D98BA0;
            --wedding-pink-light: #F4E6EA;
            --wedding-pink-dark: #C67A95;
            --wedding-cream: #FFFBF7;
            --wedding-gold: #E6C86F;
            --shadow-soft: 0 4px 20px rgba(217, 139, 160, 0.15);
            --shadow-medium: 0 8px 32px rgba(217, 139, 160, 0.2);
            --border-radius: 16px;
            --border-radius-sm: 12px;
        }

        /* Base styles with mobile-first approach */
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background: linear-gradient(135deg, var(--wedding-cream) 0%, #FAF7F2 100%);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        .font-handwriting { 
            font-family: 'Dancing Script', cursive; 
            background: linear-gradient(45deg, var(--wedding-pink), var(--wedding-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Enhanced tab styling */
        .tab-button { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-height: 54px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            border-radius: 12px;
        }
        
        .tab-button.active { 
            background: linear-gradient(135deg, var(--wedding-pink), var(--wedding-pink-dark));
            color: white;
            font-weight: 700;
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }

        .tab-button:not(.active):hover {
            background: var(--wedding-pink-light);
            color: var(--wedding-pink-dark);
            transform: scale(1.02);
        }

        /* Enhanced card styling */
        .card-enhanced {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(217, 139, 160, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card-enhanced:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        /* Button enhancements */
        .btn-primary {
            background: linear-gradient(135deg, var(--wedding-pink), var(--wedding-pink-dark));
            border: none;
            border-radius: var(--border-radius-sm);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            min-height: 48px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(217, 139, 160, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(217, 139, 160, 0.4);
        }

        .btn-secondary {
            background: white;
            border: 2px solid var(--wedding-pink-light);
            border-radius: var(--border-radius-sm);
            color: var(--wedding-pink-dark);
            font-weight: 600;
            padding: 12px 24px;
            min-height: 48px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--wedding-pink-light);
            border-color: var(--wedding-pink);
        }

        /* Form input enhancements */
        .form-input {
            border: 2px solid rgba(217, 139, 160, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 12px 16px;
            font-size: 16px; /* Prevents zoom on iOS */
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            border-color: var(--wedding-pink);
            box-shadow: 0 0 0 3px rgba(217, 139, 160, 0.1);
            outline: none;
        }

        /* Enhanced modal styling */
        .modal-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            padding: 16px;
        }
        
        .modal-content { 
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(217, 139, 160, 0.1);
        }

        /* Drag and drop enhancements */
        .draggable { 
            cursor: grab; 
            transition: all 0.3s ease;
        }
        
        .dragging { 
            opacity: 0.7; 
            background: rgba(217, 139, 160, 0.1);
            transform: scale(1.02);
            box-shadow: var(--shadow-medium);
        }
        
        .item-content { 
            cursor: pointer; 
            transition: all 0.2s ease;
        }

        .item-content:hover {
            color: var(--wedding-pink-dark);
        }

        /* Enhanced lightbox */
        .lightbox { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            touch-action: none; 
        }
        
        .lightbox-content { 
            max-width: 95vw; 
            max-height: 85vh; 
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-medium);
        }
        
        .lightbox-close { 
            position: absolute; 
            top: 20px; 
            right: 30px; 
            color: white; 
            font-size: 32px; 
            font-weight: bold; 
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .lightbox-close:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .lightbox-nav { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            color: white; 
            font-size: 24px; 
            cursor: pointer; 
            padding: 16px; 
            user-select: none;
            background: rgba(0, 0, 0, 0.5);
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-nav:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }
        
        .lightbox-prev { left: 20px; }
        .lightbox-next { right: 20px; }
        
        .photo-selection-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border: 3px solid var(--wedding-pink);
            border-radius: var(--border-radius-sm);
        }

        /* Form styling improvements */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Enhanced accordion styling */
        details > summary { 
            list-style: none; 
            transition: all 0.3s ease;
            border-radius: var(--border-radius-sm);
            padding: 16px;
            background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
            border: 1px solid rgba(56, 189, 248, 0.2);
            margin-bottom: 8px;
            color: #0369A1;
        }
        
        details > summary::-webkit-details-marker { 
            display: none; 
        }
        
        details > summary.guest-summary::after { 
            content: '▸'; 
            float: right; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            margin-left: auto;
            font-size: 18px;
            color: #0369A1;
        }
        
        details[open] > summary.guest-summary::after { 
            transform: rotate(90deg); 
        }

        details > summary:hover {
            background: linear-gradient(135deg, #E0F2FE, #F0F9FF);
            box-shadow: 0 4px 20px rgba(56, 189, 248, 0.15);
        }

        /* D-Day counter enhancement */
        .dday-counter {
            background: linear-gradient(135deg, white, var(--wedding-pink-light));
            border: 2px solid var(--wedding-pink-light);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
        }

        .dday-counter:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        /* Completed task styling */
        .completed { 
            text-decoration: line-through; 
            color: #9ca3af; 
            opacity: 0.7;
        }

        /* Mobile-specific enhancements */
        @media (max-width: 768px) {
            .tab-button {
                font-size: 12px;
                padding: 8px 4px;
                min-height: 44px;
            }

            .modal-content {
                margin: 16px;
                padding: 20px;
            }

            .lightbox-nav {
                font-size: 20px;
                padding: 12px;
                min-width: 44px;
                min-height: 44px;
            }

            .lightbox-close {
                width: 44px;
                height: 44px;
                font-size: 28px;
                top: 16px;
                right: 16px;
            }
        }

        /* Smooth animations */
        * {
            scroll-behavior: smooth;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Focus styles for accessibility */
        button:focus, 
        input:focus, 
        select:focus, 
        textarea:focus {
            outline: 2px solid var(--wedding-pink);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Password Gate -->
    <div id="password-gate" class="min-h-screen flex items-center justify-center p-4" style="background: linear-gradient(135deg, var(--wedding-cream) 0%, #FAF7F2 100%);">
        <div class="card-enhanced p-8 text-center w-full max-w-sm">
            <div class="mb-6">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-wedding-pink-light to-wedding-pink flex items-center justify-center">
                    <i class="fas fa-heart text-2xl text-white"></i>
                </div>
                <h2 class="font-handwriting text-5xl mb-2">Minwung & Jieun</h2>
                <p class="text-gray-600 text-lg">우리의 웨딩 플래너</p>
                <div class="w-16 h-1 bg-gradient-to-r from-wedding-pink to-wedding-gold mx-auto mt-3 rounded-full"></div>
            </div>
            <div class="space-y-4">
                <input type="password" id="password-input" class="form-input w-full text-center" placeholder="비밀번호를 입력하세요">
                <p id="password-error" class="text-red-500 text-sm h-5"></p>
                <button onclick="checkPassword()" class="btn-primary w-full">
                    <i class="fas fa-key mr-2"></i>입장하기
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <div class="container mx-auto p-4 max-w-4xl">
            <!-- Header -->
            <header class="text-center mb-8">
                <div class="mb-6">
                    <h1 class="font-handwriting text-3xl md:text-4xl font-bold mb-2" style="line-height: 1.2;">Minwung & Jieun</h1>
                    <p class="text-base md:text-lg text-gray-600 mb-4">우리가 함께 만드는 결혼 이야기</p>
                    <div class="flex items-center justify-center space-x-2">
                        <div class="w-8 h-0.5 bg-gradient-to-r from-transparent to-wedding-pink rounded-full"></div>
                        <i class="fas fa-heart text-wedding-pink text-lg"></i>
                        <div class="w-8 h-0.5 bg-gradient-to-l from-transparent to-wedding-pink rounded-full"></div>
                    </div>
                </div>
                
                <div class="space-y-3 flex flex-col items-center">
                    <div id="wedding-date-container" class="relative group cursor-pointer">
                        <div id="d-day-counter" class="dday-counter text-lg md:text-xl font-semibold text-center">...</div>
                        <div id="wedding-date-display" class="text-xs md:text-sm text-gray-500 mt-1 text-center"></div>
                        <input type="hidden" id="wedding-date-picker">
                    </div>
                    <div id="days-together-counter" class="text-xs md:text-sm text-gray-600 bg-white/60 backdrop-blur-sm px-3 py-1 rounded-full">...</div>
                </div>
            </header>

            <!-- Tabs -->
            <div class="mb-6 sticky top-0 z-10 bg-gradient-to-b from-wedding-cream via-wedding-cream to-transparent pb-2">
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-2 shadow-lg border border-wedding-pink-light/30">
                    <nav class="grid grid-cols-4 gap-1" aria-label="Tabs">
                        <button onclick="changeTab('checklist')" class="tab-button active text-center py-2 px-1 font-medium text-xs rounded-xl">
                            <i class="fas fa-check-square block text-base mb-1"></i>
                            <span class="block text-xs leading-tight">체크리스트</span>
                        </button>
                        <button onclick="changeTab('budget')" class="tab-button text-center py-2 px-1 font-medium text-xs rounded-xl">
                            <i class="fas fa-coins block text-base mb-1"></i>
                            <span class="block text-xs leading-tight">예산관리</span>
                        </button>
                        <button onclick="changeTab('guests')" class="tab-button text-center py-2 px-1 font-medium text-xs rounded-xl">
                            <i class="fas fa-users block text-base mb-1"></i>
                            <span class="block text-xs leading-tight">하객관리</span>
                        </button>
                        <button onclick="changeTab('photos')" class="tab-button text-center py-2 px-1 font-medium text-xs rounded-xl">
                            <i class="fas fa-images block text-base mb-1"></i>
                            <span class="block text-xs leading-tight">사진첩</span>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Content Sections -->
            <main>
                <div id="checklist" class="tab-content"></div>
                <div id="budget" class="tab-content hidden"></div>
                <div id="guests" class="tab-content hidden"></div>
                <div id="photos" class="tab-content hidden"></div>
            </main>
        </div>

        <!-- Modal -->
        <div id="itemModal" class="modal-backdrop hidden">
            <div class="modal-content">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="modal-title" class="text-xl font-bold text-wedding-pink-dark"></h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="modal-form" class="space-y-4"></form>
                <div class="flex justify-end mt-8 space-x-3">
                    <button onclick="closeModal()" class="btn-secondary">
                        <i class="fas fa-times mr-2"></i>취소
                    </button>
                    <button id="modal-save-button" onclick="handleModalSave()" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>저장
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Custom Confirm Modal -->
        <div id="confirmModal" class="modal-backdrop hidden">
            <div class="modal-content text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                </div>
                <h3 id="confirm-title" class="text-xl font-bold mb-4 text-gray-800">확인</h3>
                <p id="confirm-message" class="text-gray-600 mb-8">이 항목을 정말로 삭제하시겠습니까?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-cancel" class="btn-secondary">
                        <i class="fas fa-times mr-2"></i>취소
                    </button>
                    <button id="confirm-ok" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 hover:transform hover:scale-105 shadow-lg">
                        <i class="fas fa-check mr-2"></i>확인
                    </button>
                </div>
            </div>
        </div>

        <!-- Category Creation Modal -->
        <div id="categoryModal" class="modal-backdrop hidden">
            <div class="modal-content">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-wedding-pink-dark">
                        <i class="fas fa-folder-plus mr-2"></i>새 카테고리 만들기
                    </h3>
                    <button onclick="closeCategoryModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="category-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2 text-wedding-pink"></i>카테고리 이름
                        </label>
                        <input type="text" id="categoryName" class="form-input w-full" placeholder="예: 스튜디오, 신혼여행, 웨딩홀" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-palette mr-2 text-wedding-pink"></i>카테고리 색상 (선택)
                        </label>
                        <div class="grid grid-cols-6 gap-2">
                            <button type="button" class="w-8 h-8 rounded-full bg-blue-400 border-2 border-transparent hover:border-gray-400 category-color" data-color="blue-400"></button>
                            <button type="button" class="w-8 h-8 rounded-full bg-green-400 border-2 border-transparent hover:border-gray-400 category-color" data-color="green-400"></button>
                            <button type="button" class="w-8 h-8 rounded-full bg-purple-400 border-2 border-transparent hover:border-gray-400 category-color" data-color="purple-400"></button>
                            <button type="button" class="w-8 h-8 rounded-full bg-pink-400 border-2 border-transparent hover:border-gray-400 category-color" data-color="pink-400"></button>
                            <button type="button" class="w-8 h-8 rounded-full bg-yellow-400 border-2 border-transparent hover:border-gray-400 category-color" data-color="yellow-400"></button>
                            <button type="button" class="w-8 h-8 rounded-full bg-indigo-400 border-2 border-transparent hover:border-gray-400 category-color" data-color="indigo-400"></button>
                        </div>
                    </div>
                </form>
                <div class="flex justify-end mt-8 space-x-3">
                    <button onclick="closeCategoryModal()" class="btn-secondary">
                        <i class="fas fa-times mr-2"></i>취소
                    </button>
                    <button onclick="createCategory()" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>생성
                    </button>
                </div>
            </div>
        </div>

        <!-- Lightbox -->
        <div id="lightbox" class="lightbox hidden">
            <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
            <img class="lightbox-content" id="lightbox-img">
            <a class="lightbox-prev" onclick="showPrevPhoto()">&#10094;</a>
            <a class="lightbox-next" onclick="showNextPhoto()">&#10095;</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script type="module">
        // Firebase SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, setDoc, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- 1. Firebase 설정 ---
       const firebaseConfig = {
            apiKey: "AIzaSyAGsIe6fQKF1QiUgE3uyeWWNwc4qlzmX0E",
            authDomain: "my-wedding-planner-9ee2e.firebaseapp.com",
            projectId: "my-wedding-planner-9ee2e",
            storageBucket: "my-wedding-planner-9ee2e.firebasestorage.app",
            messagingSenderId: "7609656615",
            appId: "1:7609656615:web:d7d8c7149994bcbccdb502"
        };

        const appId = 'wedding-planner-v2';

        let app, auth, db, storage, userId, currentModal = {};
        let weddingDate = new Date('2026-04-04T13:20:00');
        
        let allChecklistItems = [], allBudgetItems = [], allGuests = [], allPhotos = [];
        
        let currentPhotoIndex = 0;
        let isFirebaseInitialized = false;

        // --- 사진첩 상태 관리 변수 ---
        let photoViewMode = 'folders'; // 'folders' 또는 'single_folder'
        let currentFolderName = null;
        let isDeleteSelectionMode = false;
        let photosSelectedForDeletion = new Set();

        const formatNumberWithCommas = (number) => number?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") || '';
        const parseFormattedNumber = (str) => parseInt(String(str).replace(/,/g, ''), 10) || 0;
        window.handleNumberInput = (e) => {
            const input = e.target;
            input.value = formatNumberWithCommas(parseFormattedNumber(input.value));
        };

        const correctPassword = '0719';
        
        // checkPassword 함수를 전역으로 정의 (HTML 로드 전에)
        function checkPassword() {
            const input = document.getElementById('password-input');
            if (input.value === correctPassword) {
                document.getElementById('password-gate').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                sessionStorage.setItem('weddingPlannerAuthenticated', 'true');
                if (!isFirebaseInitialized) {
                    initializeFirebase();
                }
            } else {
                document.getElementById('password-error').textContent = '비밀번호가 틀렸습니다.';
                input.value = '';
                input.focus();
            }
        }
        
        // 전역으로 노출
        window.checkPassword = checkPassword;

        async function initializeFirebase() {
            if (isFirebaseInitialized) return;
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase 설정이 올바르지 않습니다.");
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg"><h2 class="font-bold text-xl">데이터베이스 연결 실패</h2><p class="mt-2">Firebase 설정 정보가 올바르지 않아 앱을 실행할 수 없습니다.</p></div>`;
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                setLogLevel('debug');
                isFirebaseInitialized = true;
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authentication ready. User ID:", userId);
                        initializeDatePicker();
                        setupSnapshots();
                    } else {
                        userId = null;
                        console.log("User is signed out.");
                    }
                });
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg"><h2 class="font-bold text-xl">데이터베이스 초기화 오류</h2><p class="mt-2">오류: ${error.message}</p></div>`;
            }
        }

        function initializeDatePicker() {
            const container = document.getElementById('wedding-date-container');
            if (!container) {
                console.error("DatePicker container not found!");
                return;
            }
            flatpickr("#wedding-date-picker", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                defaultDate: weddingDate,
                wrap: true,
                appendTo: container, 
                onChange: async (selectedDates) => { 
                    if(db && userId && selectedDates.length > 0) {
                        await setDoc(doc(db, `artifacts/${appId}/public/data/settings`, "main"), { weddingDate: selectedDates[0] }); 
                    }
                }
            });
        }

        function renderActiveTab() {
            const activeTabButton = document.querySelector('.tab-button.active');
            if (!activeTabButton) return;
            const tabName = activeTabButton.getAttribute('onclick').match(/'([^']+)'/)[1];

            if (tabName === 'checklist') {
                window.renderChecklist(allChecklistItems);
            } else if (tabName === 'budget') {
                window.renderBudget(allBudgetItems);
            } else if (tabName === 'guests') {
                window.renderGuests(allGuests);
            } else if (tabName === 'photos') {
                window.renderPhotos(allPhotos);
            }
        }

        window.changeTab = (tabName) => {
            if (photoViewMode !== 'folders' || isDeleteSelectionMode) {
                exitDeleteMode(false);
                navigateBackToFolders(false);
            }

            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const container = document.getElementById(tabName);
            container.classList.remove('hidden');

            if (!container.innerHTML.trim()) {
                loadTabContent(tabName);
            }

            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`button[onclick="changeTab('${tabName}')"]`).classList.add('active');
            
            renderActiveTab();
        };

        const updateDday = (date) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weddingDay = new Date(date);
            weddingDay.setHours(0, 0, 0, 0);
            const diffTime = weddingDay - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            document.getElementById('d-day-counter').innerHTML = diffDays > 0 ? `💍 Wedding D-${diffDays}` : (diffDays === 0 ? `❤️ Happy Wedding Day!` : `🎉 Married for ${Math.abs(diffDays)} days`);
            document.getElementById('wedding-date-display').textContent = date.toLocaleString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const updateDaysTogether = () => {
            const metDate = new Date('2025-07-19T00:00:00');
            const diffDays = Math.floor((new Date() - metDate) / (1000 * 60 * 60 * 24));
            if (diffDays >= 0) {
                document.getElementById('days-together-counter').innerHTML = `함께한 지 <span class="font-semibold text-pink-500">${diffDays + 1}</span>일째`;
            }
        };
        
        window.addGuestNameField = () => {
            const container = document.getElementById('guest-names-container');
            const newEntry = document.createElement('div');
            newEntry.className = 'flex items-center mt-1 guest-name-entry';
            newEntry.innerHTML = `
                <input type="text" name="guestName" class="w-full p-2 border rounded" required>
                <button type="button" onclick="this.parentElement.remove()" class="ml-2 text-red-500 hover:text-red-700"><i class="fas fa-minus-circle"></i></button>
            `;
            container.appendChild(newEntry);
            newEntry.querySelector('input').focus();
        };

        window.openModal = (type, mode, item = {}) => {
            currentModal = { type, mode, item };
            const modal = document.getElementById('itemModal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('modal-form');
            form.innerHTML = '';
            const isEdit = mode === 'edit';

            if (type === 'checklist') {
                title.textContent = isEdit ? '체크리스트 수정' : '새 체크리스트 항목';
                form.innerHTML = `<input type="hidden" id="itemId" value="${item.id || ''}">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tasks mr-2 text-wedding-pink"></i>항목 내용
                        </label>
                        <input type="text" id="checklistItemText" class="form-input w-full" value="${item.text || ''}" placeholder="할 일을 입력하세요" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2 text-wedding-pink"></i>대분류 카테고리
                        </label>
                        <select id="checklistItemCategorySelect" class="form-input w-full mb-2">
                            <option value="">📁 새 카테고리 만들기</option>
                        </select>
                        <input type="text" id="checklistItemCategory" value="${item.category || ''}" class="form-input w-full" placeholder="새 카테고리 이름 입력" style="display: none;">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tags mr-2 text-wedding-pink"></i>중분류 (선택사항)
                        </label>
                        <select id="checklistItemSubCategorySelect" class="form-input w-full mb-2">
                            <option value="">-- 중분류 없음 --</option>
                            <option value="_new_">-- 새 중분류 만들기 --</option>
                        </select>
                        <input type="text" id="checklistItemSubCategory" value="${item.subCategory || ''}" class="form-input w-full" placeholder="새 중분류 이름 입력" style="display: none;">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-2 text-wedding-pink"></i>날짜
                        </label>
                        <input type="text" id="checklistItemDate" value="${item.date || ''}" class="form-input w-full" placeholder="날짜와 시간을 선택하세요">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-sticky-note mr-2 text-wedding-pink"></i>메모
                        </label>
                        <textarea id="checklistItemMemo" class="form-input w-full" rows="3" placeholder="간단한 메모를 남겨보세요">${item.memo || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-2 text-wedding-pink"></i>장소 (선택)
                        </label>
                        <input type="text" id="checklistItemLocation" placeholder="예: 창원 리베라 컨벤션" class="form-input w-full" value="${item.location || ''}">
                    </div>`;
                
                // 기존 카테고리 목록 추가
                setTimeout(() => {
                    const categorySelect = document.getElementById('checklistItemCategorySelect');
                    const categoryInput = document.getElementById('checklistItemCategory');
                    const subCategorySelect = document.getElementById('checklistItemSubCategorySelect');
                    const subCategoryInput = document.getElementById('checklistItemSubCategory');
                    
                    // 기존 대분류 카테고리 추가
                    const existingCategories = [...new Set(allChecklistItems.map(item => item.category).filter(Boolean))];
                    existingCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categorySelect.appendChild(option);
                    });
                    
                    // 수정 모드일 때 기존 값 설정
                    if (isEdit && item.category) {
                        if (existingCategories.includes(item.category)) {
                            categorySelect.value = item.category;
                        } else {
                            categorySelect.value = '';
                            categoryInput.style.display = 'block';
                            categoryInput.value = item.category;
                        }
                    }
                    
                    // 카테고리 선택 이벤트
                    categorySelect.addEventListener('change', (e) => {
                        if (e.target.value === '') {
                            categoryInput.style.display = 'block';
                            categoryInput.focus();
                        } else {
                            categoryInput.style.display = 'none';
                            categoryInput.value = e.target.value;
                            
                            // 해당 카테고리의 중분류 업데이트
                            updateSubCategories(e.target.value);
                        }
                    });
                    
                    // 중분류 선택 이벤트
                    subCategorySelect.addEventListener('change', (e) => {
                        if (e.target.value === '_new_') {
                            subCategoryInput.style.display = 'block';
                            subCategoryInput.focus();
                        } else {
                            subCategoryInput.style.display = 'none';
                            subCategoryInput.value = e.target.value;
                        }
                    });
                    
                    function updateSubCategories(selectedCategory) {
                        // 기존 중분류 옵션 제거 (기본 옵션 제외)
                        while (subCategorySelect.children.length > 2) {
                            subCategorySelect.removeChild(subCategorySelect.lastChild);
                        }
                        
                        // 해당 대분류의 중분류들 추가
                        const subCategories = [...new Set(allChecklistItems
                            .filter(item => item.category === selectedCategory && item.subCategory)
                            .map(item => item.subCategory))];
                        
                        subCategories.forEach(subCat => {
                            const option = document.createElement('option');
                            option.value = subCat;
                            option.textContent = subCat;
                            subCategorySelect.appendChild(option);
                        });
                    }
                    
                    // 수정 모드일 때 중분류도 설정
                    if (isEdit && item.category) {
                        updateSubCategories(item.category);
                        if (item.subCategory) {
                            setTimeout(() => {
                                subCategorySelect.value = item.subCategory || '';
                            }, 0);
                        }
                    }
                }, 0);
                
                flatpickr("#checklistItemDate", { enableTime: true, dateFormat: "Y-m-d H:i" });
            } else if (type === 'budget') {
                title.textContent = isEdit ? '예산 항목 수정' : '새 예산 항목';
                form.innerHTML = `
                    <input type="hidden" id="itemId" value="${item.id || ''}">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-list mr-2 text-wedding-pink"></i>카테고리
                        </label>
                        <select id="budgetCategory" class="form-input w-full">
                            <option value="웨딩홀">🏛️ 웨딩홀</option>
                            <option value="예단, 예물">💍 예단, 예물</option>
                            <option value="신혼여행">✈️ 신혼여행</option>
                            <option value="기타">📝 기타</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-shopping-cart mr-2 text-wedding-pink"></i>항목
                        </label>
                        <input type="text" id="budgetItem" value="${item.item || ''}" class="form-input w-full" placeholder="예: 웨딩홀 대관료" required>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <label class="block text-sm font-semibold text-blue-700 mb-3">
                            <i class="fas fa-calculator mr-2"></i>예상 금액
                        </label>
                        <div class="flex items-center bg-white rounded-lg border-2 border-blue-200">
                            <button type="button" onclick="adjustBudget('budgetEstimated', -10000)" class="px-4 py-3 text-blue-600 hover:bg-blue-50 rounded-l-lg transition-colors">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="text" inputmode="numeric" id="budgetEstimated" value="${formatNumberWithCommas(item.estimatedAmount || '')}" oninput="handleNumberInput(event)" class="flex-1 p-3 text-center font-semibold border-0 focus:outline-none" placeholder="0">
                            <button type="button" onclick="adjustBudget('budgetEstimated', 10000)" class="px-4 py-3 text-blue-600 hover:bg-blue-50 rounded-r-lg transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-pink-50 p-4 rounded-xl space-y-4">
                        <h4 class="text-sm font-semibold text-pink-700 mb-3">
                            <i class="fas fa-receipt mr-2"></i>실제 지출
                        </h4>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">실제 총액</label>
                            <div class="flex items-center bg-white rounded-lg border-2 border-pink-200">
                                <button type="button" onclick="adjustBudget('budgetTotal', -10000)" class="px-3 py-2 text-pink-600 hover:bg-pink-50 rounded-l-lg transition-colors text-sm">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="text" inputmode="numeric" id="budgetTotal" value="${formatNumberWithCommas(item.totalAmount || 0)}" oninput="handleNumberInput(event)" class="flex-1 p-2 text-center text-sm border-0 focus:outline-none">
                                <button type="button" onclick="adjustBudget('budgetTotal', 10000)" class="px-3 py-2 text-pink-600 hover:bg-pink-50 rounded-r-lg transition-colors text-sm">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">계약금</label>
                            <div class="flex items-center bg-white rounded-lg border-2 border-pink-200">
                                <button type="button" onclick="adjustBudget('budgetDeposit', -10000)" class="px-3 py-2 text-pink-600 hover:bg-pink-50 rounded-l-lg transition-colors text-sm">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="text" inputmode="numeric" id="budgetDeposit" value="${formatNumberWithCommas(item.deposit || 0)}" oninput="handleNumberInput(event)" class="flex-1 p-2 text-center text-sm border-0 focus:outline-none">
                                <button type="button" onclick="adjustBudget('budgetDeposit', 10000)" class="px-3 py-2 text-pink-600 hover:bg-pink-50 rounded-r-lg transition-colors text-sm">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">
                                <i class="fas fa-user-friends mr-1"></i>지불자
                            </label>
                            <select id="budgetPayer" class="form-input w-full text-sm">
                                <option value="joint">👫 공동</option>
                                <option value="groom">🤵 민웅</option>
                                <option value="bride">👰 지은</option>
                            </select>
                        </div>
                    </div>`;
                setTimeout(() => {
                    if(isEdit) {
                        document.getElementById('budgetPayer').value = item.payer || 'joint';
                        document.getElementById('budgetCategory').value = item.category || '기타';
                    }
                }, 0);
            } else if (type === 'guest') {
                title.textContent = isEdit ? '하객 정보 수정' : '새 하객 추가';
                let formHTML = `
                    <input type="hidden" id="itemId" value="${item.id || ''}">
                    <div><label class="block text-sm font-medium">소속</label><select id="guestSide" class="mt-1 w-full p-2 border rounded"><option value="groom">민웅</option><option value="bride">지은</option></select></div>
                    <div><label class="block text-sm font-medium">관계</label><select id="guestRelation" class="mt-1 w-full p-2 border rounded"><option value="family">가족</option><option value="friend">친구</option><option value="coworker">직장동료</option><option value="etc">기타</option></select></div>
                    <hr>
                    <div id="guest-names-container" style="max-height: 150px; overflow-y: auto; padding-right: 5px;">
                        <label class="block text-sm font-medium">이름</label>
                        <div class="flex items-center mt-1 guest-name-entry">
                            <input type="text" name="guestName" class="w-full p-2 border rounded" required>
                        </div>
                    </div>
                    <button type="button" onclick="addGuestNameField()" class="mt-2 text-sm text-pink-500 hover:text-pink-700"><i class="fas fa-plus mr-1"></i>이름 추가</button>
                `;
                if (isEdit) {
                    formHTML = `<input type="hidden" id="itemId" value="${item.id || ''}">
                        <div><label class="block text-sm font-medium">이름</label><input type="text" name="guestName" value="${item.name || ''}" class="mt-1 w-full p-2 border rounded" required></div>
                        <div><label class="block text-sm font-medium">소속</label><select id="guestSide" class="mt-1 w-full p-2 border rounded"><option value="groom">민웅</option><option value="bride">지은</option></select></div>
                        <div><label class="block text-sm font-medium">관계</label><select id="guestRelation" class="mt-1 w-full p-2 border rounded"><option value="family">가족</option><option value="friend">친구</option><option value="coworker">직장동료</option><option value="etc">기타</option></select></div>`;
                }
                form.innerHTML = formHTML;
                if(isEdit) { 
                    document.getElementById('guestSide').value = item.side; 
                    document.getElementById('guestRelation').value = item.relation; 
                }
            } else if (type === 'photo') {
                title.textContent = '사진 올리기';
                const existingFolders = [...new Set(allPhotos.map(p => p.folderName).filter(Boolean))];
                const folderOptions = existingFolders.map(f => `<option value="${f}">${f}</option>`).join('');
                form.innerHTML = `<div><label class="block text-sm font-medium">폴더 선택</label><select id="photoFolderSelect" class="mt-1 w-full p-2 border rounded"><option value="">기타</option>${folderOptions}<option value="_new_">-- 새 폴더 만들기 --</option></select></div><div id="newFolderInputContainer" class="hidden"><label class="block text-sm font-medium">새 폴더 이름</label><input type="text" id="newFolderName" class="mt-1 w-full p-2 border rounded"></div><div><label class="block text-sm font-medium">사진 파일 (여러 장 선택 가능)</label><input type="file" id="photoFileInput" class="mt-1 w-full" accept="image/*" required multiple></div><div id="photo-upload-progress" class="text-sm text-gray-500 hidden"></div>`;
                document.getElementById('photoFolderSelect').addEventListener('change', (e) => {
                    document.getElementById('newFolderInputContainer').classList.toggle('hidden', e.target.value !== '_new_');
                });
            }
            modal.classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('itemModal').classList.add('hidden');

        // 카테고리 모달 관련 함수들
        window.openCategoryModal = () => {
            document.getElementById('categoryModal').classList.remove('hidden');
            document.getElementById('categoryName').focus();
        };

        window.closeCategoryModal = () => {
            document.getElementById('categoryModal').classList.add('hidden');
            document.getElementById('categoryName').value = '';
            document.querySelectorAll('.category-color').forEach(btn => {
                btn.classList.remove('border-wedding-pink', 'border-2');
                btn.classList.add('border-transparent');
            });
        };

        window.createCategory = () => {
            const categoryName = document.getElementById('categoryName').value.trim();
            const selectedColor = document.querySelector('.category-color.border-wedding-pink')?.dataset.color || 'blue-400';
            
            if (!categoryName) {
                alert('카테고리 이름을 입력해주세요.');
                return;
            }

            // 기존 카테고리와 중복 확인
            const existingCategories = [...new Set(allChecklistItems.map(item => item.category).filter(Boolean))];
            if (existingCategories.includes(categoryName)) {
                alert('이미 존재하는 카테고리입니다.');
                return;
            }

            // 카테고리 생성 (실제로는 체크리스트 아이템으로 저장)
            if (db && userId) {
                addDoc(collection(db, `artifacts/${appId}/public/data/categories`), {
                    name: categoryName,
                    color: selectedColor,
                    createdAt: new Date(),
                    type: 'category'
                }).then(() => {
                    closeCategoryModal();
                    // 체크리스트 리렌더링
                    renderActiveTab();
                }).catch(error => {
                    console.error('카테고리 생성 실패:', error);
                    alert('카테고리 생성에 실패했습니다.');
                });
            } else {
                alert('데이터베이스 연결이 필요합니다.');
            }
        };

        // 색상 선택 이벤트
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('category-color')) {
                    document.querySelectorAll('.category-color').forEach(btn => {
                        btn.classList.remove('border-wedding-pink', 'border-2');
                        btn.classList.add('border-transparent');
                    });
                    e.target.classList.remove('border-transparent');
                    e.target.classList.add('border-wedding-pink', 'border-2');
                }
            });
        });

        window.adjustBudget = (inputId, amount) => {
            const input = document.getElementById(inputId);
            if (input) { 
                let currentValue = parseFormattedNumber(input.value); 
                currentValue += amount; 
                if (currentValue < 0) currentValue = 0; 
                input.value = formatNumberWithCommas(currentValue); 
            }
        };
        
        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('confirmModal');
            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');
            
            document.getElementById('confirm-message').textContent = message;
            
            if (message.includes('중복된 하객')) {
                okBtn.textContent = '추가';
                cancelBtn.textContent = '취소';
            } else {
                okBtn.textContent = '삭제';
                 cancelBtn.textContent = '취소';
            }

            confirmModal.classList.remove('hidden');
            
            const close = () => {
                confirmModal.classList.add('hidden');
                okBtn.onclick = null;
                cancelBtn.onclick = null;
            };
            okBtn.onclick = () => {
                close();
                onConfirm();
            };
            cancelBtn.onclick = close;
        }

        window.handleModalSave = () => { currentModal.type === 'photo' ? handlePhotoUpload() : handleFormSubmit(); }

        async function handlePhotoUpload() {
            if (!db || !storage || !userId) { console.error("DB/Storage not ready or user not authenticated."); return; }
            const fileInput = document.getElementById('photoFileInput');
            const files = fileInput.files;
            if (files.length === 0) {
                showConfirm("사진 파일을 선택해주세요.", () => {});
                return;
            }
            
            let folderName = document.getElementById('photoFolderSelect').value;
            if (folderName === '_new_') {
                folderName = document.getElementById('newFolderName').value.trim();
                if (!folderName) {
                    showConfirm("새 폴더 이름을 입력해주세요.", () => {});
                    return;
                }
            }

            const progressDiv = document.getElementById('photo-upload-progress');
            progressDiv.classList.remove('hidden');
            const saveButton = document.getElementById('modal-save-button');
            
            saveButton.disabled = true;
            saveButton.textContent = '업로드 중...';

            const totalFiles = files.length;
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < totalFiles; i++) {
                const file = files[i];
                progressDiv.textContent = `(${i + 1}/${totalFiles}) "${file.name}" 업로드 중...`;
                const storageRef = ref(storage, `photos/${Date.now()}_${file.name}`);
                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    await addDoc(collection(db, `artifacts/${appId}/public/data/photos`), { 
                        url: downloadURL, 
                        storagePath: snapshot.ref.fullPath, 
                        folderName: folderName || null, 
                        createdAt: new Date() 
                    });
                    successCount++;
                } catch (error) { 
                    console.error(`"${file.name}" Upload failed`, error); 
                    errorCount++;
                }
            }
            
            saveButton.disabled = false;
            saveButton.textContent = '저장';

            if(errorCount > 0) {
                progressDiv.textContent = `✅ ${successCount}개 성공, ❌ ${errorCount}개 실패`;
            } else {
                progressDiv.textContent = `✅ 총 ${successCount}개 사진 업로드 완료!`;
            }

            setTimeout(() => closeModal(), 2000);
        }

        window.handleFormSubmit = async () => {
            if (!db || !userId) { alert("데이터베이스 연결 준비 안됨"); return; }
            const { type, mode, item } = currentModal;
            const id = document.getElementById('itemId')?.value || item.id;

            try {
                if (type === 'checklist') {
                    const categoryInput = document.getElementById('checklistItemCategory');
                    const subCategoryInput = document.getElementById('checklistItemSubCategory');
                    
                    const data = {
                        text: document.getElementById('checklistItemText').value.trim(),
                        category: categoryInput.value.trim() || '기타',
                        subCategory: subCategoryInput.value.trim() || null,
                        date: document.getElementById('checklistItemDate').value.trim(),
                        memo: document.getElementById('checklistItemMemo').value.trim(),
                        location: document.getElementById('checklistItemLocation').value.trim()
                    };
                    if (!data.text) { alert('항목 내용을 입력해주세요.'); return; }
                    
                    if (mode === 'edit' && id) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/checklists`, id), data);
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/checklists`), { ...data, order: Date.now(), createdAt: new Date(), completed: false });
                    }
                } else if (type === 'budget') {
                    const data = {
                        category: document.getElementById('budgetCategory').value,
                        item: document.getElementById('budgetItem').value.trim(),
                        estimatedAmount: parseFormattedNumber(document.getElementById('budgetEstimated').value),
                        totalAmount: parseFormattedNumber(document.getElementById('budgetTotal').value),
                        deposit: parseFormattedNumber(document.getElementById('budgetDeposit').value),
                        payer: document.getElementById('budgetPayer').value
                    };
                    if (!data.item) { alert('항목을 입력해주세요.'); return; }

                    if (mode === 'edit' && id) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/budgets`, id), data);
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/budgets`), { ...data, createdAt: new Date() });
                    }
                } else if (type === 'guest') {
                    if (mode === 'edit' && id) {
                        const data = {
                            name: document.querySelector('input[name="guestName"]').value.trim(),
                            side: document.getElementById('guestSide').value,
                            relation: document.getElementById('guestRelation').value,
                        };
                        if (!data.name) { alert('하객 이름을 입력해주세요.'); return; }

                        const isDuplicate = allGuests.some(g => g.id !== id && g.name === data.name);
                        const processUpdate = async () => {
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/guests`, id), data);
                            closeModal();
                        };
                        if (isDuplicate) {
                            showConfirm('중복된 하객이 존재합니다. 확인하시기 바랍니다.', processUpdate);
                            return; 
                        }
                        await processUpdate();
                    } else { 
                        const nameInputs = document.querySelectorAll('input[name="guestName"]');
                        const names = [...nameInputs].map(input => input.value.trim()).filter(Boolean);
                        if (names.length === 0) { alert("하객 이름을 한 명 이상 입력해주세요."); return; }
                        
                        const side = document.getElementById('guestSide').value;
                        const relation = document.getElementById('guestRelation').value;
                        const duplicates = names.filter(name => allGuests.some(g => g.name === name));

                        const processSave = async () => {
                            const batch = writeBatch(db);
                            names.forEach(name => {
                                const docRef = doc(collection(db, `artifacts/${appId}/public/data/guests`));
                                batch.set(docRef, { name, side, relation, createdAt: new Date() });
                            });
                            await batch.commit();
                            closeModal();
                        };

                        if (duplicates.length > 0) {
                            showConfirm(`중복된 하객(${duplicates.join(', ')})이 존재합니다. 확인하시기 바랍니다.`, processSave);
                            return; 
                        }
                        await processSave();
                    }
                    return;
                }
            } catch (e) {
                console.error("저장 중 오류 발생: ", e);
            }
            closeModal();
        };
        
        window.deleteItem = async (collectionName, id) => {
            const message = collectionName === 'guests' ? '이 하객을 정말로 삭제하시겠습니까?' : '정말로 삭제하시겠습니까?';
            showConfirm(message, async () => {
                if (!db || !userId) { console.error("DB not ready or user not authenticated."); return; }
                try {
                    if (collectionName === 'photos') {
                        const photoToDelete = allPhotos.find(p => p.id === id);
                        if (photoToDelete && photoToDelete.storagePath) {
                            await deleteObject(ref(storage, photoToDelete.storagePath));
                        }
                    }
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, id));
                } catch (error) {
                    console.error("Error deleting item:", error);
                }
            });
        };
        
        window.editBudgetItem = (id) => { const item = allBudgetItems.find(i => i.id === id); if(item) openModal('budget', 'edit', item); };
        window.editGuestItem = (id) => { const item = allGuests.find(i => i.id === id); if(item) openModal('guest', 'edit', item); };
        
        const lightbox = document.getElementById('lightbox');
        let touchStartX = 0;
        const handleTouchStart = (e) => { touchStartX = e.changedTouches[0].screenX; };
        const handleTouchEnd = (e) => {
            let touchEndX = e.changedTouches[0].screenX;
            if (touchStartX - touchEndX > 50) { showNextPhoto(); } 
            else if (touchEndX - startX > 50) { showPrevPhoto(); }
        };

        window.openLightbox = (index) => {
            if (isDeleteSelectionMode) return;
            
            const currentVisiblePhotos = (photoViewMode === 'single_folder' && currentFolderName)
                ? allPhotos.filter(p => (p.folderName || '기타') === currentFolderName)
                : allPhotos;

            const photoToOpen = allPhotos[index];
            currentPhotoIndex = currentVisiblePhotos.findIndex(p => p.id === photoToOpen.id);
            if (currentPhotoIndex === -1) currentPhotoIndex = 0;

            document.getElementById('lightbox-img').src = currentVisiblePhotos[currentPhotoIndex].url;
            lightbox.classList.remove('hidden');
            lightbox.addEventListener('touchstart', handleTouchStart, { passive: true });
            lightbox.addEventListener('touchend', handleTouchEnd, { passive: true });
        };

        window.closeLightbox = () => {
            lightbox.classList.add('hidden');
            lightbox.removeEventListener('touchstart', handleTouchStart);
            lightbox.removeEventListener('touchend', handleTouchEnd);
        };
        
        const updateLightboxImage = () => {
             const currentVisiblePhotos = (photoViewMode === 'single_folder' && currentFolderName)
                ? allPhotos.filter(p => (p.folderName || '기타') === currentFolderName)
                : allPhotos;
            if (currentVisiblePhotos.length > 0) {
                 document.getElementById('lightbox-img').src = currentVisiblePhotos[currentPhotoIndex].url;
            }
        }

        window.showNextPhoto = () => {
            const currentVisiblePhotos = (photoViewMode === 'single_folder' && currentFolderName)
                ? allPhotos.filter(p => (p.folderName || '기타') === currentFolderName)
                : allPhotos;
            if (currentVisiblePhotos.length === 0) return;
            currentPhotoIndex = (currentPhotoIndex + 1) % currentVisiblePhotos.length;
            updateLightboxImage();
        };

        window.showPrevPhoto = () => {
            const currentVisiblePhotos = (photoViewMode === 'single_folder' && currentFolderName)
                ? allPhotos.filter(p => (p.folderName || '기타') === currentFolderName)
                : allPhotos;
            if (currentVisiblePhotos.length === 0) return;
            currentPhotoIndex = (currentPhotoIndex - 1 + currentVisiblePhotos.length) % currentVisiblePhotos.length;
            updateLightboxImage();
        };

        function loadTabContent(tabName) {
            const container = document.getElementById(tabName);
            if (tabName === 'checklist') {
                container.innerHTML = `<div class="card-enhanced p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-wedding-pink-light to-wedding-pink flex items-center justify-center mr-3">
                                <i class="fas fa-check-square text-white"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-wedding-pink-dark">준비 목록</h2>
                        </div>
                        <button onclick="openModal('checklist', 'add')" class="btn-primary text-sm">
                            <i class="fas fa-plus mr-1"></i>추가
                        </button>
                    </div>
                    <div id="checklist-container"></div>
                </div>`;
            }
            else if (tabName === 'budget') {
                container.innerHTML = `<div class="card-enhanced p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-wedding-gold/80 to-wedding-gold flex items-center justify-center mr-3">
                                <i class="fas fa-coins text-white"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-wedding-pink-dark">예산 관리</h2>
                        </div>
                        <button onclick="openModal('budget', 'add')" class="btn-primary text-sm">
                            <i class="fas fa-plus mr-2"></i>항목 추가
                        </button>
                    </div>
                    <div id="budget-list"></div>
                    <div id="grand-total" class="mt-8"></div>
                </div>`;
            }
            else if (tabName === 'guests') {
                container.innerHTML = `<div class="card-enhanced p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-500 flex items-center justify-center mr-3">
                                <i class="fas fa-users text-white"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-wedding-pink-dark">하객 명단</h2>
                        </div>
                        <button onclick="openModal('guest', 'add')" class="btn-primary text-sm">
                            <i class="fas fa-user-plus mr-2"></i>하객 추가
                        </button>
                    </div>
                    <div class="space-y-6">
                        <div id="groom-container"></div>
                        <div id="bride-container"></div>
                    </div>
                </div>`;
            }
            else if (tabName === 'photos') {
                container.innerHTML = `<div class="card-enhanced p-6">
                    <div id="photo-header" class="flex justify-between items-center mb-6">
                    </div>
                    <div id="photo-gallery-container" class="space-y-8"></div>
                </div>`;
            }
        }

        function setupSnapshots() {
            if (!db) return;
            onSnapshot(doc(db, `artifacts/${appId}/public/data/settings`, "main"), (docSnap) => {
                if (docSnap.exists() && docSnap.data().weddingDate) { 
                    weddingDate = docSnap.data().weddingDate.toDate(); 
                }
                updateDday(weddingDate);
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/checklists`), (snap) => {
                allChecklistItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderActiveTab();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/budgets`), (snap) => {
                allBudgetItems = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                renderActiveTab();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/guests`), (snap) => {
                allGuests = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                renderActiveTab();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/photos`), (snap) => {
                allPhotos = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderActiveTab();
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('weddingPlannerAuthenticated') === 'true') {
                document.getElementById('password-gate').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initializeFirebase();
            }
            document.getElementById('password-input').addEventListener('keyup', (event) => { if (event.key === "Enter") { event.preventDefault(); checkPassword(); } });
            
            updateDday(weddingDate);
            updateDaysTogether();
            setInterval(updateDaysTogether, 1000 * 60 * 60);
            loadTabContent('checklist');
            
            // PWA Service Worker 등록
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then((registration) => {
                            console.log('SW registered: ', registration);
                        })
                        .catch((registrationError) => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }
        });

        // --- 렌더링 함수들 ---
        window.renderBudget = function(items) {
            const list = document.getElementById('budget-list');
            const grandTotalDiv = document.getElementById('grand-total');
            if (!list || !grandTotalDiv) return;

            list.innerHTML = '';
            list.className = 'space-y-6';
            
            const totals = {
                all: { estimated: 0, actual: 0 },
                groom: { estimated: 0, actual: 0 },
                bride: { estimated: 0, actual: 0 },
            };

            items.forEach(item => {
                const estimated = item.estimatedAmount || 0;
                const actual = item.totalAmount || 0;
                
                totals.all.estimated += estimated;
                totals.all.actual += actual;

                if (item.payer === 'groom') {
                    totals.groom.estimated += estimated;
                    totals.groom.actual += actual;
                } else if (item.payer === 'bride') {
                    totals.bride.estimated += estimated;
                    totals.bride.actual += actual;
                } else { // 'joint' or undefined
                    totals.groom.estimated += estimated / 2;
                    totals.groom.actual += actual / 2;
                    totals.bride.estimated += estimated / 2;
                    totals.bride.actual += actual / 2;
                }
            });

            // 카테고리별로 그룹화 (기존 데이터 유지)
            const grouped = items.reduce((acc, item) => {
                const key = item.category || '기타';
                if (!acc[key]) acc[key] = [];
                acc[key].push(item);
                return acc;
            }, {});

            // 카테고리별로 렌더링 (동적으로 카테고리 순서 결정)
            const categoryOrder = Object.keys(grouped).sort((a, b) => {
                // 기존 카테고리 우선순위 유지
                const priorityOrder = ['웨딩홀', '예단, 예물', '신혼여행', '기타'];
                const aIndex = priorityOrder.indexOf(a);
                const bIndex = priorityOrder.indexOf(b);
                
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return a.localeCompare(b);
            });

            categoryOrder.forEach(category => {
                const categoryItems = grouped[category];
                const categoryTotalEstimated = categoryItems.reduce((sum, item) => sum + (item.estimatedAmount || 0), 0);
                const categoryTotalActual = categoryItems.reduce((sum, item) => sum + (item.totalAmount || 0), 0);
                
                // 카테고리 헤더
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'bg-gradient-to-r from-blue-50 to-cyan-50 p-4 rounded-xl border border-blue-200';
                categoryHeader.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${categoryIcons[category] || '📝'}</span>
                            <div>
                                <h3 class="font-bold text-blue-800 text-lg">${category}</h3>
                                <p class="text-sm text-blue-600">${categoryItems.length}개 항목</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-blue-600">예상: ${formatNumberWithCommas(categoryTotalEstimated)}원</p>
                            <p class="font-bold text-blue-800">실제: ${formatNumberWithCommas(categoryTotalActual)}원</p>
                        </div>
                    </div>
                `;
                list.appendChild(categoryHeader);

                // 카테고리 내 항목들
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'grid gap-3 sm:grid-cols-2 lg:grid-cols-3 mt-4';

                categoryItems.forEach(item => {
                const { estimatedAmount: estimated = 0, totalAmount: actual = 0, deposit = 0 } = item;
                const balance = actual - deposit;
                const paymentProgress = actual > 0 ? (deposit / actual * 100) : 0;
                
                // 예산 비교 계산
                const budgetDiff = actual - estimated;
                const budgetDiffPercent = estimated > 0 ? (budgetDiff / estimated * 100) : 0;
                
                // 상태 결정
                let statusColor = 'gray';
                let statusText = '미정';
                let statusIcon = 'fas fa-clock';
                
                if (actual > 0) {
                    if (budgetDiffPercent <= -5) {
                        statusColor = 'green';
                        statusText = `${Math.abs(budgetDiffPercent).toFixed(0)}% 절약!`;
                        statusIcon = 'fas fa-arrow-down';
                    } else if (budgetDiffPercent <= 10) {
                        statusColor = 'blue';
                        statusText = '예산 내';
                        statusIcon = 'fas fa-check-circle';
                    } else {
                        statusColor = 'red';
                        statusText = `${budgetDiffPercent.toFixed(0)}% 초과`;
                        statusIcon = 'fas fa-arrow-up';
                    }
                }
                
                // 카테고리 아이콘
                const categoryIcons = {
                    '웨딩홀': '🏛️',
                    '예단, 예물': '💍',
                    '신혼여행': '✈️',
                    '기타': '📝'
                };
                
                const payerBadge = { 
                    groom: 'bg-blue-100 text-blue-800', 
                    bride: 'bg-teal-100 text-teal-800', 
                    joint: 'bg-green-100 text-green-800'
                }[item.payer] || 'bg-green-100 text-green-800';
                
                const payerText = { 
                    groom: '🤵 민웅', 
                    bride: '👰 지은', 
                    joint: '👫 공동'
                }[item.payer] || '👫 공동';
                
                const card = document.createElement('div');
                card.className = 'card-enhanced p-4 hover:shadow-lg transition-all duration-300 cursor-pointer';
                card.onclick = () => editBudgetItem(item.id);
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${categoryIcons[item.category] || '📝'}</span>
                            <div>
                                <h3 class="font-bold text-gray-800 text-sm leading-tight">${item.item}</h3>
                                <span class="text-xs px-2 py-1 rounded-full ${payerBadge} mt-1 inline-block">${payerText}</span>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteItem('budgets', '${item.id}')" 
                                class="text-gray-400 hover:text-red-500 p-1 rounded transition-colors">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500">예상</span>
                            <span class="font-semibold text-gray-700">${formatNumberWithCommas(estimated)}원</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500">실제</span>
                            <span class="font-bold text-lg">${formatNumberWithCommas(actual)}원</span>
                        </div>
                    </div>
                    
                    ${actual > 0 ? `
                        <div class="mb-3">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>결제 진행률</span>
                                <span>${paymentProgress.toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-gradient-to-r from-wedding-pink to-wedding-pink-dark h-2 rounded-full transition-all duration-500" 
                                     style="width: ${Math.min(paymentProgress, 100)}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>계약금: ${formatNumberWithCommas(deposit)}원</span>
                                <span>잔금: ${formatNumberWithCommas(balance)}원</span>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center justify-center py-2 rounded-lg ${
                        statusColor === 'green' ? 'bg-green-50 text-green-700' :
                        statusColor === 'blue' ? 'bg-blue-50 text-blue-700' :
                        statusColor === 'red' ? 'bg-red-50 text-red-700' :
                        'bg-gray-50 text-gray-500'
                    }">
                        <i class="${statusIcon} mr-2 text-sm"></i>
                        <span class="font-medium text-sm">${statusText}</span>
                    </div>
                `;
                        
                        itemsContainer.appendChild(card);
                    });
                    
                    list.appendChild(itemsContainer);
                }
            });

            // 전체 통계 카드도 개선
            grandTotalDiv.innerHTML = `
                <div class="card-enhanced p-6 bg-gradient-to-br from-wedding-pink-light to-white">
                    <div class="text-center mb-4">
                        <h3 class="text-xl font-bold text-wedding-pink-dark mb-2">💰 전체 예산 현황</h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-white/60 rounded-lg p-3">
                                <p class="text-xs text-gray-500">총 예상</p>
                                <p class="font-bold text-lg text-gray-700">${formatNumberWithCommas(totals.all.estimated)}원</p>
                            </div>
                            <div class="bg-white/60 rounded-lg p-3">
                                <p class="text-xs text-gray-500">총 지출</p>
                                <p class="font-bold text-lg text-wedding-pink-dark">${formatNumberWithCommas(totals.all.actual)}원</p>
                            </div>
                        </div>
                    </div>
                    
                    <details class="cursor-pointer">
                        <summary class="text-center text-sm text-gray-600 hover:text-wedding-pink-dark transition-colors">
                            👫 개별 부담 현황 보기 ▼
                        </summary>
                        <div class="mt-4 grid grid-cols-2 gap-3">
                            <div class="bg-blue-50 rounded-lg p-3 text-center">
                                <p class="font-semibold text-blue-700 mb-1">🤵 민웅</p>
                                <p class="text-xs text-gray-600">예상: ${formatNumberWithCommas(totals.groom.estimated)}원</p>
                                <p class="text-sm font-bold text-blue-700">지출: ${formatNumberWithCommas(totals.groom.actual)}원</p>
                            </div>
                            <div class="bg-teal-50 rounded-lg p-3 text-center">
                                <p class="font-semibold text-teal-600 mb-1">👰 지은</p>
                                <p class="text-xs text-gray-600">예상: ${formatNumberWithCommas(totals.bride.estimated)}원</p>
                                <p class="text-sm font-bold text-teal-600">지출: ${formatNumberWithCommas(totals.bride.actual)}원</p>
                            </div>
                        </div>
                    </details>
                </div>`;
        };
        window.renderChecklist = function(items) {
            const container = document.getElementById('checklist-container');
            if (!container) return;
            container.innerHTML = '';
            container.className = 'space-y-3';
            const grouped = items.reduce((acc, item) => { 
                const key = item.category || '기타'; 
                if (!acc[key]) acc[key] = {}; 
                const subKey = item.subCategory || '기본';
                if (!acc[key][subKey]) acc[key][subKey] = [];
                acc[key][subKey].push(item);
                return acc; 
            }, {});
            
            Object.keys(grouped).sort().forEach(category => {
                const categoryData = grouped[category];
                const totalItemCount = Object.values(categoryData).flat().length;
                
                const details = document.createElement('details');
                details.className = 'bg-gray-50 rounded-lg';

                const summary = document.createElement('summary');
                summary.className = 'p-3 font-semibold cursor-pointer flex items-center guest-summary';

                summary.innerHTML = `
                    <span class="flex-grow text-lg">${category} (${totalItemCount})</span>
                `;

                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'px-3 pb-3 pt-1 space-y-3';

                // 중분류별로 처리
                Object.keys(categoryData).sort().forEach(subCategory => {
                    const subCategoryItems = categoryData[subCategory];
                    
                    if (subCategory !== '기본') {
                        // 중분류 제목 추가
                        const subTitle = document.createElement('div');
                        subTitle.className = 'text-sm font-medium text-gray-600 mt-3 mb-2 pl-2 border-l-3 border-wedding-pink-light';
                        subTitle.textContent = `${subCategory} (${subCategoryItems.length})`;
                        categoryContainer.appendChild(subTitle);
                    }
                    
                    const listContainer = document.createElement('div');
                    listContainer.className = 'space-y-2';

                    subCategoryItems.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'draggable flex items-center justify-between p-3 bg-white rounded-lg shadow-sm';
                    div.setAttribute('draggable', true);
                    div.dataset.id = item.id;
                    div.dataset.order = item.order;
                    
                    let detailsHTML = '';
                    if (item.date) detailsHTML += `<p class="text-xs text-gray-500 ${item.completed ? 'completed' : ''}"><i class="far fa-calendar-alt fa-fw mr-1"></i>${item.date}</p>`;
                    if (item.memo) detailsHTML += `<p class="text-xs text-gray-500 ${item.completed ? 'completed' : ''}"><i class="far fa-sticky-note fa-fw mr-1"></i>${item.memo}</p>`;
                    if (item.location) detailsHTML += `<a href="https://map.naver.com/p/search/${encodeURIComponent(item.location)}" target="_blank" class="text-xs text-blue-500 hover:underline ${item.completed ? 'completed' : ''}" onclick="event.stopPropagation();"><i class="fas fa-map-marker-alt fa-fw mr-1"></i>${item.location}</a>`;
                    
                    div.innerHTML = `<div class="flex items-center flex-grow"><i class="fas fa-grip-vertical text-gray-300 mr-3 handle"></i><input type="checkbox" id="check-${item.id}" class="h-5 w-5 rounded border-gray-300 text-pink-600 focus:ring-pink-500" ${item.completed ? 'checked' : ''}><div class="ml-3 flex-grow item-content"><p class="${item.completed ? 'completed' : ''}">${item.text}</p><div class="mt-1 space-y-1">${detailsHTML}</div></div></div><button onclick="deleteItem('checklists', '${item.id}')" class="ml-2 text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt fa-sm"></i></button>`;
                    
                    div.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                        if (db && userId) {
                            updateDoc(doc(db, `artifacts/${appId}/public/data/checklists`, item.id), { completed: e.target.checked });
                        }
                    });
                    div.querySelector('.item-content').addEventListener('click', () => openModal('checklist', 'edit', item));
                    
                    let draggedItem = null;
                    div.addEventListener('dragstart', (e) => { draggedItem = div; setTimeout(() => div.classList.add('dragging'), 0); });
                    div.addEventListener('dragend', () => div.classList.remove('dragging'));
                    listContainer.addEventListener('dragover', e => e.preventDefault());
                    listContainer.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        if (!draggedItem || !db || !userId) return;
                        const afterElement = [...listContainer.querySelectorAll('.draggable:not(.dragging)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element;
                        const siblings = Array.from(listContainer.querySelectorAll('.draggable'));
                        const dropIndex = afterElement ? siblings.indexOf(afterElement) : siblings.length;
                        const prevOrder = siblings[dropIndex - 1] ? parseFloat(siblings[dropIndex - 1].dataset.order) : 0;
                        const nextOrder = siblings[dropIndex] ? parseFloat(siblings[dropIndex].dataset.order) : Date.now();
                        const newOrder = (prevOrder + nextOrder) / 2;
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/checklists`, draggedItem.dataset.id), { order: newOrder });
                        draggedItem = null;
                    });
                        listContainer.appendChild(div);
                    });
                    
                    categoryContainer.appendChild(listContainer);
                });

                details.appendChild(summary);
                details.appendChild(categoryContainer);
                container.appendChild(details);
            });
        };
        window.renderGuests = function(items) {
            const containerMap = { 
                groom: document.getElementById('groom-container'), 
                bride: document.getElementById('bride-container') 
            };
            if (!containerMap.groom || !containerMap.bride) return;

            containerMap.groom.innerHTML = ''; 
            containerMap.bride.innerHTML = '';
            
            const relationText = { family: '가족', friend: '친구', coworker: '직장동료', etc: '기타' };

            const groupedBySide = items.reduce((acc, item) => {
                const side = item.side || 'groom';
                if (!acc[side]) acc[side] = [];
                acc[side].push(item);
                return acc;
            }, { groom: [], bride: [] });

            for (const side of ['groom', 'bride']) {
                const sideContainer = containerMap[side];
                const sideGuests = groupedBySide[side];
                const sideTitle = side === 'groom' ? `🤵 민웅측 (${sideGuests.length}명)` : `👰 지은측 (${sideGuests.length}명)`;
                const sideColor = side === 'groom' ? 'text-blue-600' : 'text-teal-600';

                const sideDetails = document.createElement('details');
                sideDetails.innerHTML = `<summary class="text-lg font-semibold mb-2 ${sideColor} cursor-pointer flex justify-between items-center guest-summary"><h3>${sideTitle}</h3></summary>`;
                
                const relationListContainer = document.createElement('div');
                relationListContainer.className = 'space-y-3 pl-4';
                
                const groupedByRelation = sideGuests.reduce((acc, item) => {
                    const relation = item.relation || 'etc';
                    if (!acc[relation]) acc[relation] = [];
                    acc[relation].push(item);
                    return acc;
                }, {});

                Object.keys(relationText).forEach(relationKey => {
                    if (groupedByRelation[relationKey]) {
                        const guestsInRelation = groupedByRelation[relationKey];
                        const details = document.createElement('details');
                        details.className = 'bg-gray-50 rounded-lg';
                        
                        const summary = document.createElement('summary');
                        summary.className = 'p-3 font-semibold cursor-pointer flex justify-between items-center guest-summary';
                        summary.innerHTML = `<span>${relationText[relationKey]} (${guestsInRelation.length}명)</span>`;
                        
                        const listDiv = document.createElement('div');
                        listDiv.className = 'px-3 pb-3 space-y-2';

                        guestsInRelation.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'p-2 bg-white rounded flex justify-between items-center';
                            div.innerHTML = `<span class="item-content flex-grow">${item.name}</span>
                                            <div class="space-x-2">
                                                <button onclick="editGuestItem('${item.id}')" class="text-gray-400 hover:text-blue-500"><i class="fas fa-pen fa-sm"></i></button>
                                                <button onclick="deleteItem('guests', '${item.id}')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt fa-sm"></i></button>
                                            </div>`;
                            listDiv.appendChild(div);
                        });

                        details.appendChild(summary);
                        details.appendChild(listDiv);
                        relationListContainer.appendChild(details);
                    }
                });
                sideDetails.appendChild(relationListContainer);
                sideContainer.appendChild(sideDetails);
            }
        };

        // --- 사진첩 관련 함수들 ---
        
        function updatePhotoHeader() {
            const header = document.getElementById('photo-header');
            if (!header) return;
            
            let title = '우리의 추억';
            let titleIcon = '<i class="fas fa-images text-purple-500 mr-3"></i>';
            let buttons = `<button onclick="enterDeleteMode()" class="btn-secondary text-sm p-3"><i class="fas fa-trash-alt"></i></button>
                           <button id="add-photo-btn" onclick="openModal('photo', 'add')" class="btn-primary text-sm ml-2 p-3"><i class="fas fa-upload"></i></button>`;

            if (isDeleteSelectionMode) {
                const selectedCount = photosSelectedForDeletion.size;
                title = `${selectedCount}개 사진 선택됨`;
                titleIcon = '<i class="fas fa-check-circle text-red-500 mr-3"></i>';
                buttons = `<button onclick="exitDeleteMode(true)" class="btn-secondary text-sm p-3"><i class="fas fa-times"></i></button>
                           <button onclick="deleteSelectedPhotos()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-300 hover:transform hover:scale-105 shadow-lg text-sm ml-2 ${selectedCount === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${selectedCount === 0 ? 'disabled' : ''}><i class="fas fa-trash-alt"></i></button>`;
            } else if (photoViewMode === 'single_folder') {
                title = currentFolderName;
                titleIcon = '<i class="fas fa-folder-open text-purple-500 mr-3"></i>';
                buttons = `<button onclick="navigateBackToFolders(true)" class="btn-secondary text-sm p-3"><i class="fas fa-arrow-left"></i></button>
                           <button onclick="enterDeleteMode()" class="btn-secondary text-sm ml-2 p-3"><i class="fas fa-trash-alt"></i></button>
                           <button id="add-photo-btn" onclick="openModal('photo', 'add')" class="btn-primary text-sm ml-2 p-3"><i class="fas fa-upload"></i></button>`;
            }

            header.innerHTML = `
                <div class="flex items-center">
                    ${titleIcon}
                    <h2 class="text-2xl font-bold text-wedding-pink-dark">${title}</h2>
                </div>
                <div class="flex flex-wrap gap-2">${buttons}</div>`;
        }

        window.navigateToFolder = (folderName) => {
            photoViewMode = 'single_folder';
            currentFolderName = folderName;
            renderPhotos(allPhotos);
        };

        window.navigateBackToFolders = (render = true) => {
            photoViewMode = 'folders';
            currentFolderName = null;
            if (render) renderPhotos(allPhotos);
        };

        window.enterDeleteMode = () => {
            isDeleteSelectionMode = true;
            photosSelectedForDeletion.clear();
            renderPhotos(allPhotos);
        };

        window.exitDeleteMode = (render = true) => {
            isDeleteSelectionMode = false;
            photosSelectedForDeletion.clear();
            if (render) renderPhotos(allPhotos);
        };

        window.togglePhotoSelection = (photoId) => {
            const photoDiv = document.querySelector(`[data-photo-id="${photoId}"]`);
            if (photosSelectedForDeletion.has(photoId)) {
                photosSelectedForDeletion.delete(photoId);
                photoDiv.querySelector('.photo-selection-overlay')?.remove();
            } else {
                photosSelectedForDeletion.add(photoId);
                const overlay = document.createElement('div');
                overlay.className = 'photo-selection-overlay';
                overlay.innerHTML = `<i class="fas fa-check-circle text-4xl text-pink-500"></i>`;
                photoDiv.appendChild(overlay);
            }
            updatePhotoHeader();
        };

        window.deleteSelectedPhotos = async () => {
            const count = photosSelectedForDeletion.size;
            if (count === 0) return;

            showConfirm(`${count}개의 사진을 정말로 삭제하시겠습니까?`, async () => {
                if (!db || !userId) { console.error("DB not ready."); return; }

                const batch = writeBatch(db);
                const deletePromises = [];

                photosSelectedForDeletion.forEach(id => {
                    const photoToDelete = allPhotos.find(p => p.id === id);
                    if (photoToDelete) {
                        batch.delete(doc(db, `artifacts/${appId}/public/data/photos`, id));
                        if (photoToDelete.storagePath) {
                            deletePromises.push(deleteObject(ref(storage, photoToDelete.storagePath)));
                        }
                    }
                });

                try {
                    await batch.commit();
                    await Promise.all(deletePromises);
                    console.log(`${count} photos deleted successfully.`);
                } catch (error) {
                    console.error("Error deleting selected photos:", error);
                } finally {
                    exitDeleteMode(true);
                }
            });
        };
        
        const handlePhotoInteraction = (e, photo, originalIndex) => {
            e.preventDefault();
            if (isDeleteSelectionMode) {
                togglePhotoSelection(photo.id);
                return;
            }
            openLightbox(originalIndex);
        };

        window.renderPhotos = function(items) {
            const container = document.getElementById('photo-gallery-container');
            if (!container) return;
            
            container.innerHTML = '';
            updatePhotoHeader();

            if (items.length === 0 && photoViewMode === 'folders') {
                container.innerHTML = '<p class="text-center text-gray-500">아직 사진이 없어요. 첫 사진을 올려보세요!</p>';
                return;
            }

            if (photoViewMode === 'folders') {
                renderAllFoldersView(items, container);
            } else {
                renderSingleFolderView(items, container);
            }
        };

        function renderAllFoldersView(items, container) {
            const groupedByFolder = items.reduce((acc, photo) => { const folder = photo.folderName || '기타'; if (!acc[folder]) acc[folder] = []; acc[folder].push(photo); return acc; }, {});
            const sortedFolders = Object.keys(groupedByFolder).sort((a, b) => { if (a === '기타') return 1; if (b === '기타') return -1; return a.localeCompare(b); });
            
            sortedFolders.forEach(folderName => {
                const photosInFolder = groupedByFolder[folderName];
                const folderDiv = document.createElement('div');
                folderDiv.className = "cursor-pointer";
                folderDiv.onclick = () => navigateToFolder(folderName);

                const photoPreviews = photosInFolder.slice(0, 3).map(photo => 
                    `<div class="relative aspect-square bg-gray-100 rounded-lg overflow-hidden">
                        <img src="${photo.url}" 
                             class="w-full h-full object-cover" 
                             loading="lazy" 
                             decoding="async"
                             style="transition: opacity 0.3s ease;"
                             onload="this.style.opacity='1'"
                             onerror="this.onerror=null;this.src='https://placehold.co/400x400/FFFBF7/D98BA0?text=Error';this.style.opacity='1'">
                    </div>`
                ).join('');

                folderDiv.innerHTML = `
                    <div class="flex justify-between items-center border-b pb-2 mb-3">
                        <h3 class="text-xl font-semibold text-gray-700">${folderName}</h3>
                        <span class="text-sm font-normal text-gray-500">${photosInFolder.length}장 ></span>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-3 gap-2">${photoPreviews}</div>`;
                container.appendChild(folderDiv);
            });
        }

        function renderSingleFolderView(items, container) {
            const photosInFolder = items.filter(p => (p.folderName || '기타') === currentFolderName);
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-3 sm:grid-cols-4 gap-2';

            if(photosInFolder.length === 0) {
                navigateBackToFolders(true);
                return;
            }

            photosInFolder.forEach(photo => {
                const originalIndex = allPhotos.findIndex(p => p.id === photo.id);
                const photoWrapper = document.createElement('div');
                photoWrapper.className = "relative aspect-square bg-gray-100 rounded-lg overflow-hidden group cursor-pointer";
                photoWrapper.dataset.photoId = photo.id;
                
                photoWrapper.innerHTML = `<img src="${photo.url}" 
                                               class="w-full h-full object-cover" 
                                               loading="lazy" 
                                               decoding="async"
                                               style="transition: opacity 0.3s ease;"
                                               onload="this.style.opacity='1'"
                                               onerror="this.onerror=null;this.src='https://placehold.co/400x400/FFFBF7/D98BA0?text=Error';this.style.opacity='1'">`;
                
                if (isDeleteSelectionMode && photosSelectedForDeletion.has(photo.id)) {
                    const overlay = document.createElement('div');
                    overlay.className = 'photo-selection-overlay';
                    overlay.innerHTML = `<i class="fas fa-check-circle text-4xl text-pink-500"></i>`;
                    photoWrapper.appendChild(overlay);
                }

                photoWrapper.addEventListener('click', (e) => handlePhotoInteraction(e, photo, originalIndex));
                
                grid.appendChild(photoWrapper);
            });
            container.appendChild(grid);
        }
    </script>
</body>
</html>

